<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Connection Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 40px;
            background: #0a0a0a;
            color: white;
        }

        .log-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }

        .success {
            color: #00ff88;
        }

        .error {
            color: #ff4d4d;
        }

        .info {
            color: #00f3ff;
        }

        button {
            padding: 12px 24px;
            background: #00f3ff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Firestore Connection Test</h1>
    <p>This page will try to write a test document and then delete it to verify your connection.</p>
    <button id="testBtn">Run Test</button>
    <div id="logs" class="log-container" style="margin-top: 20px;"></div>

    <script type="module">
        import { db } from "./firebase.js";
        import { doc, setDoc, getDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const logs = document.getElementById('logs');
        const testBtn = document.getElementById('testBtn');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        testBtn.onclick = async () => {
            logs.innerHTML = '';
            log("Starting Firestore connection test...");

            try {
                const testRef = doc(db, "connection_test", "status");

                log("1. Attempting to WRITE test document...", 'info');
                await setDoc(testRef, {
                    lastConnect: serverTimestamp(),
                    message: "Connection successful"
                });
                log("Success: Written to 'connection_test/status' ✔", 'success');

                log("2. Attempting to READ test document...", 'info');
                const snap = await getDoc(testRef);
                if (snap.exists()) {
                    log(`Success: Data retrieved: ${JSON.stringify(snap.data())} ✔`, 'success');
                } else {
                    log("Fail: Document was written but cannot be found.", 'error');
                }

                log("3. Attempting to DELETE test document...", 'info');
                await deleteDoc(testRef);
                log("Success: Cleaned up test data ✔", 'success');

                log("--- TEST PASSED: Connection to Firestore is ACTIVE ---", 'success');
            } catch (err) {
                console.error(err);
                log(`ERROR: ${err.message}`, 'error');
                log("--- TEST FAILED: Check your Firestore rules or Console settings ---", 'error');

                if (err.message.includes('permission')) {
                    log("TIP: Make sure you have 'Published' the rules in the Firebase Console.", 'info');
                } else if (err.message.includes('NOT_FOUND')) {
                    log("TIP: Ensure you have 'Created' the Cloud Firestore database in your project.", 'info');
                }
            }
        };
    </script>
</body>

</html>