<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Manual Verification - Dashboard Refactor</title>
    <style>
        body {
            font-family: system-ui;
            background: #111;
            color: #eee;
            padding: 20px;
            line-height: 1.6;
        }

        .test-card {
            background: #222;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .pass {
            background: #004400;
            color: #00ff00;
        }

        .fail {
            background: #440000;
            color: #ff0000;
        }

        pre {
            background: #000;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            color: #00ff00;
        }

        button {
            padding: 10px 20px;
            background: #00e5ff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Dashboard Refactor Verification</h1>
    <p>This page tests the school-aware managers and the extracted ResultsManagement module.</p>

    <div class="test-card">
        <h3>1. Manager Loading & Integration</h3>
        <p>Checks if all managers are correctly linked and exposed to <code>window</code>.</p>
        <div id="test-1-status">Testing...</div>
    </div>

    <div class="test-card">
        <h3>2. School-Aware Data Isolation</h3>
        <p>Checks if switching schools correctly filters data without page reload.</p>
        <button onclick="runSchoolTest()">Run School Test</button>
        <div id="test-2-result" style="margin-top:10px;"></div>
    </div>

    <div class="test-card">
        <h3>3. Results Management & Sync</h3>
        <p>Checks if ResultsManagement correctly handles data syncing and ranking.</p>
        <button onclick="runResultsTest()">Run Results Test</button>
        <div id="test-3-result" style="margin-top:10px;"></div>
    </div>

    <!-- Core Dependencies -->
    <script src="../assets/js/storage-manager.js"></script>
    <script src="../assets/js/academic-year-manager.js"></script>
    <script src="../assets/js/exam-type-manager.js"></script>
    <script src="../assets/js/exam-manager.js"></script>
    <script src="../assets/js/results-management.js"></script>
    <script src="../assets/js/analytics-engine.js"></script>

    <script type="module">
        import SchoolManager from '../assets/js/school-manager.js';
        window.SchoolManager = SchoolManager;

        window.addEventListener('DOMContentLoaded', () => {
            checkManagers();
        });

        function checkManagers() {
            const status = document.getElementById('test-1-status');
            const managers = [
                'StorageManager', 'SchoolManager', 'AcademicYearManager',
                'ExamTypeManager', 'ExamManager', 'ResultsManagement', 'AnalyticsEngine'
            ];

            const results = managers.map(m => {
                const exists = window[m] !== undefined;
                return `<li>${m}: <span class="status ${exists ? 'pass' : 'fail'}">${exists ? 'LOADED' : 'MISSING'}</span></li>`;
            });

            status.innerHTML = `<ul>${results.join('')}</ul>`;
        }

        window.runSchoolTest = async function () {
            const res = document.getElementById('test-2-result');
            res.innerHTML = "Initializing test data...";

            // Set mock schools
            localStorage.setItem('schools', JSON.stringify([
                { id: 'school_a', name: 'School A' },
                { id: 'school_b', name: 'School B' }
            ]));

            // Set mock exam types for each school
            const mockTypes = [
                { id: '1', name: 'Type A', schoolId: 'school_a', active: true },
                { id: '2', name: 'Type B', schoolId: 'school_b', active: true }
            ];
            localStorage.setItem('exam_types', JSON.stringify(mockTypes));

            SchoolManager.init();

            // Switch to School A
            SchoolManager.setActive('school_a');
            const typesA = ExamTypeManager.getAll();
            const passA = typesA.length === 1 && typesA[0].schoolId === 'school_a';

            // Switch to School B
            SchoolManager.setActive('school_b');
            const typesB = ExamTypeManager.getAll();
            const passB = typesB.length === 1 && typesB[0].schoolId === 'school_b';

            res.innerHTML = `
                <p>School A Types Detected: ${typesA.length} (Expected: 1)</p>
                <p>School B Types Detected: ${typesB.length} (Expected: 1)</p>
                <div class="status ${passA && passB ? 'pass' : 'fail'}">${passA && passB ? 'DATA ISOLATION PASSED' : 'DATA ISOLATION FAILED'}</div>
            `;
        }

        window.runResultsTest = function () {
            const res = document.getElementById('test-3-result');

            // Mock exam
            const examId = 'exam_123';
            const mockExam = { id: examId, name: 'Final Exam', year: '2024', type: 'Annual', schoolId: 'school_a' };
            localStorage.setItem('exams', JSON.stringify([mockExam]));

            // Mock raw data
            const rawData = [
                { rollNo: '101', name: 'Alice', totalMarks: 450, schoolId: 'school_a', examId: examId },
                { rollNo: '102', name: 'Bob', totalMarks: 480, schoolId: 'school_a', examId: examId }
            ];

            // Manually trigger storage save (simulating sync)
            localStorage.setItem('exam_results_cache', JSON.stringify(rawData));

            // Test Ranking Logic (internal ResultsManagement rank assignment should beBob=1, Alice=2)
            // Note: ResultsManagement ranking happens during sync. Since we mock storage, we just checking retrieval.
            const results = ResultsManagement.getAllResults();
            const alice = results.find(r => r.rollNo === '101');

            res.innerHTML = `
                <p>Retrieved Results: ${results.length} (Expected: 2)</p>
                <p>First Result Name: ${results[1].name} (Alice)</p>
                <div class="status ${results.length === 2 ? 'pass' : 'fail'}">${results.length === 2 ? 'RESULTS MANAGEMENT PASSED' : 'RESULTS MANAGEMENT FAILED'}</div>
            `;
        }
    </script>
</body>

</html>