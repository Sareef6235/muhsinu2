<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News CMS | Administrative Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --cms-primary: #00f3ff;
            --cms-secondary: #bc13fe;
            --cms-bg: #050508;
            --cms-glass: rgba(255, 255, 255, 0.03);
            --cms-border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--cms-bg);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Outfit', sans-serif;
        }

        .cms-header {
            padding: 20px 40px;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--cms-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .cms-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            flex: 1;
        }

        @media (max-width: 1100px) {
            .cms-layout {
                grid-template-columns: 1fr;
            }
        }

        .cms-panel {
            background: var(--cms-bg);
            padding: 40px;
            overflow-y: auto;
            max-height: calc(100vh - 85px);
            border-right: 1px solid var(--cms-border);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cms-input,
        .cms-textarea,
        .cms-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--cms-border);
            padding: 15px;
            border-radius: 12px;
            color: #fff;
            font-family: inherit;
            transition: all 0.3s;
            outline: none;
        }

        .cms-input:focus,
        .cms-textarea:focus {
            border-color: var(--cms-primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }

        /* Tabs System */
        .lang-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--cms-border);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--cms-border);
            color: #888;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: var(--cms-primary);
            color: #000;
            border-color: var(--cms-primary);
        }

        .lang-content {
            display: none;
        }

        .lang-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-box {
            border: 2px dashed var(--cms-border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }

        .upload-box:hover {
            border-color: var(--cms-primary);
            background: rgba(0, 243, 255, 0.02);
        }

        .preview-img-container {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            max-height: 200px;
            display: none;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            position: sticky;
            bottom: 0;
            background: var(--cms-bg);
            padding-top: 20px;
            border-top: 1px solid var(--cms-border);
        }

        .btn-cms {
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-cms-primary {
            background: var(--cms-primary);
            color: #000;
        }

        .btn-cms-secondary {
            background: #222;
            color: #fff;
            border: 1px solid var(--cms-border);
        }

        .btn-cms:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* List Styling */
        .news-item {
            background: var(--cms-glass);
            border: 1px solid var(--cms-border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            transition: 0.3s;
        }

        .news-item-img {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            object-fit: cover;
            background: #111;
        }

        .news-item-info {
            flex: 1;
        }

        /* Toast Improvement */
        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 30px;
            border-radius: 12px;
            background: #111;
            border: 1px solid var(--cms-primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: #fff;
            transform: translateY(150px);
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #toast.show {
            transform: translateY(0);
        }
    </style>
</head>

<body>

    <header class="cms-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="admin/dashboard.html" class="action-btn"><i class="ph ph-arrow-left"></i></a>
            <div>
                <h1 style="font-size: 1.2rem; font-weight: 700;">NEWS & NOTICE CMS</h1>
                <p style="font-size: 0.8rem; color: #666;">Multilingual Admin Panel</p>
            </div>
        </div>
        <div style="display: flex; gap: 15px;">
            <a href="index.html#news" target="_blank" class="btn-cms btn-cms-outline" style="padding: 10px 20px;">
                <i class="ph ph-eye"></i> View Live
            </a>
            <button class="btn-cms btn-cms-primary" style="padding: 10px 20px;" onclick="location.reload()">
                <i class="ph ph-arrows-clockwise"></i> Refresh
            </button>
        </div>
    </header>

    <div class="cms-layout">
        <!-- FORM PANEL -->
        <div class="cms-panel">
            <h2 style="margin-bottom: 25px; font-size: 1.5rem;" id="form-title">Create New Article</h2>

            <form id="news-form">
                <input type="hidden" id="post-id">

                <div class="lang-tabs">
                    <button type="button" class="tab-btn active" onclick="switchLang('en')">English</button>
                    <button type="button" class="tab-btn" onclick="switchLang('ml')">Malayalam</button>
                    <button type="button" class="tab-btn" onclick="switchLang('ar')">Arabic</button>
                </div>

                <!-- ENGLISH CONTENT -->
                <div id="lang-en" class="lang-content active">
                    <div class="form-group">
                        <label class="form-label">Article Title (English)</label>
                        <input type="text" id="title-en" class="cms-input" placeholder="Enter English title..."
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Short Summary (English)</label>
                        <textarea id="short-en" class="cms-textarea" style="height: 80px;" maxlength="150"
                            placeholder="Brief summary..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Article (English)</label>
                        <textarea id="content-en" class="cms-textarea" style="height: 200px;"
                            placeholder="Full content..."></textarea>
                    </div>
                </div>

                <!-- MALAYALAM CONTENT -->
                <div id="lang-ml" class="lang-content">
                    <div class="form-group">
                        <label class="form-label">ലേഖനത്തിന്റെ തലക്കെട്ട് (Malayalam)</label>
                        <input type="text" id="title-ml" class="cms-input" placeholder="മലയാളം ടൈറ്റിൽ നൽകുക...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ചുരുക്കം (Malayalam)</label>
                        <textarea id="short-ml" class="cms-textarea" style="height: 80px;" maxlength="150"
                            placeholder="വിവരണം..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">പൂർണ്ണമായ ഉള്ളടക്കം (Malayalam)</label>
                        <textarea id="content-ml" class="cms-textarea" style="height: 200px;"
                            placeholder="മുഴുവൻ വാർത്തയും..."></textarea>
                    </div>
                </div>

                <!-- ARABIC CONTENT -->
                <div id="lang-ar" class="lang-content">
                    <div class="form-group" dir="rtl">
                        <label class="form-label">عنوان المقال (Arabic)</label>
                        <input type="text" id="title-ar" class="cms-input" placeholder="أدخل العنوان بالعربية...">
                    </div>
                    <div class="form-group" dir="rtl">
                        <label class="form-label">ملخص قصير (Arabic)</label>
                        <textarea id="short-ar" class="cms-textarea" style="height: 80px;" maxlength="150"
                            placeholder="ملخص..."></textarea>
                    </div>
                    <div class="form-group" dir="rtl">
                        <label class="form-label">المحتوى الكامل (Arabic)</label>
                        <textarea id="content-ar" class="cms-textarea" style="height: 200px;"
                            placeholder="المحتوى الكامل هنا..."></textarea>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">Publication Date</label>
                        <input type="date" id="post-date" class="cms-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="post-status" class="cms-select">
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Featured Image (Max 100KB)</label>
                    <div class="upload-box" onclick="document.getElementById('post-image').click()">
                        <i class="ph ph-cloud-arrow-up" style="font-size: 2rem; color: var(--cms-primary);"></i>
                        <p style="margin-top: 10px; color: #888;">Select Image To Upload</p>
                        <input type="file" id="post-image" hidden accept="image/*">
                        <div class="preview-img-container" id="preview-img-container">
                            <img src="" id="form-img-preview" style="width: 100%;">
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-cms btn-cms-primary" id="publish-btn"
                        onclick="saveData('published')">
                        <i class="ph ph-paper-plane-tilt"></i> <span>Publish Now</span>
                    </button>
                    <button type="button" class="btn-cms btn-cms-secondary" id="draft-btn" onclick="saveData('draft')">
                        <i class="ph ph-file-text"></i> Save Draft
                    </button>
                    <button type="button" class="btn-cms btn-cms-outline" onclick="resetForm()">
                        <i class="ph ph-arrow-counter-clockwise"></i> Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- LIST PANEL -->
        <div class="cms-panel" style="background: rgba(0,0,0,0.15); border-right: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-size: 1.5rem;">Article Management</h2>
                <div style="position: relative;">
                    <i class="ph ph-magnifying-glass"
                        style="position: absolute; left: 15px; top: 18px; color: #666;"></i>
                    <input type="text" class="cms-input" id="search-box" style="padding-left: 45px; height: 50px;"
                        placeholder="Search news...">
                </div>
            </div>

            <div id="posts-list">
                <!-- Loaded via JS -->
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast">
        <i class="ph ph-check-circle" style="color: var(--cms-primary); font-size: 1.5rem;"></i>
        <span id="toast-msg">Action Successful!</span>
    </div>

    <script type="module">
        import { NewsService } from './news-service.js';

        const newsService = new NewsService();
        const postsList = document.getElementById('posts-list');
        const searchBox = document.getElementById('search-box');
        const imgContainer = document.getElementById('preview-img-container');
        const imgPreview = document.getElementById('form-img-preview');
        let currentCompressedBase64 = null;

        // --- TABS LOGIC ---
        window.switchLang = (lang) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.lang-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`lang-${lang}`).classList.add('active');
        };

        // --- INITIAL LOAD ---
        window.addEventListener('load', () => {
            renderList();
            resetForm();
        });

        // --- RENDER LIST ---
        function renderList() {
            const news = newsService.getAllNews();
            const searchTerm = searchBox.value.toLowerCase();
            const filtered = news.filter(n => (n.title.en || '').toLowerCase().includes(searchTerm) || (n.title.ml || '').toLowerCase().includes(searchTerm));

            if (filtered.length === 0) {
                postsList.innerHTML = `<div style="text-align: center; color: #444; padding: 50px;">No articles found.</div>`;
                return;
            }

            postsList.innerHTML = filtered.map(item => `
                <div class="news-item">
                    <img src="${item.image || 'https://via.placeholder.com/150'}" class="news-item-img">
                    <div class="news-item-info">
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 5px;">
                            <span class="status-tag status-${item.status}">${item.status}</span>
                            <span style="color: #555; font-size: 0.7rem;">${new Date(item.createdAt).toLocaleDateString()}</span>
                        </div>
                        <h4 style="margin-bottom: 3px; font-size: 0.95rem;">${item.title.en || item.title.ml || 'Untitled'}</h4>
                        <p style="color: #666; font-size: 0.75rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;">${item.shortDescription.en || item.shortDescription.ml || ''}</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <button class="action-btn action-edit" onclick="editPost('${item.id}')"><i class="ph ph-pencil"></i></button>
                        <button class="action-btn action-delete" onclick="deletePost('${item.id}')"><i class="ph ph-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        searchBox.addEventListener('input', renderList);

        // --- IMAGE HANDLING ---
        document.getElementById('post-image').addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                try {
                    currentCompressedBase64 = await NewsService.compressImage(file);
                    imgPreview.src = currentCompressedBase64;
                    imgContainer.style.display = 'block';
                } catch (err) {
                    showToast("Compression failed", true);
                }
            }
        });

        // --- SAVE DATA ---
        window.saveData = async (statusOverride) => {
            const btn = document.getElementById('publish-btn');
            const draftBtn = document.getElementById('draft-btn');
            const id = document.getElementById('post-id').value;

            const data = {
                id: id || null,
                title: {
                    en: document.getElementById('title-en').value,
                    ml: document.getElementById('title-ml').value,
                    ar: document.getElementById('title-ar').value
                },
                shortDescription: {
                    en: document.getElementById('short-en').value,
                    ml: document.getElementById('short-ml').value,
                    ar: document.getElementById('short-ar').value
                },
                fullContent: {
                    en: document.getElementById('content-en').value,
                    ml: document.getElementById('content-ml').value,
                    ar: document.getElementById('content-ar').value
                },
                image: currentCompressedBase64,
                date: document.getElementById('post-date').value || new Date().toISOString(),
                status: statusOverride || document.getElementById('post-status').value,
                createdAt: id ? newsService.getNewsById(id).createdAt : new Date().toISOString()
            };

            if (!data.title.en && !data.title.ml && !data.title.ar) {
                showToast("Please provide a title in at least one language.", true);
                return;
            }

            // UI Feedback
            btn.disabled = true;
            draftBtn.disabled = true;
            btn.querySelector('span').innerText = "Saving...";

            try {
                await newsService.saveNews(data);
                showToast(statusOverride === 'published' ? "News Published Successfully!" : "Draft Saved!");

                if (statusOverride === 'published') {
                    setTimeout(() => {
                        window.location.href = 'index.html#news';
                    }, 1500);
                } else {
                    renderList();
                    resetForm();
                }
            } catch (err) {
                showToast(err.message, true);
            } finally {
                btn.disabled = false;
                draftBtn.disabled = false;
                btn.querySelector('span').innerText = id ? "Update Article" : "Publish Now";
            }
        };

        window.editPost = (id) => {
            const item = newsService.getNewsById(id);
            if (!item) return;

            document.getElementById('form-title').innerText = "Edit Article";
            document.getElementById('post-id').value = item.id;

            document.getElementById('title-en').value = item.title.en || '';
            document.getElementById('title-ml').value = item.title.ml || '';
            document.getElementById('title-ar').value = item.title.ar || '';

            document.getElementById('short-en').value = item.shortDescription.en || '';
            document.getElementById('short-ml').value = item.shortDescription.ml || '';
            document.getElementById('short-ar').value = item.shortDescription.ar || '';

            document.getElementById('content-en').value = item.fullContent.en || '';
            document.getElementById('content-ml').value = item.fullContent.ml || '';
            document.getElementById('content-ar').value = item.fullContent.ar || '';

            document.getElementById('post-date').value = item.date ? item.date.split('T')[0] : '';
            document.getElementById('post-status').value = item.status || 'published';

            if (item.image) {
                currentCompressedBase64 = item.image;
                imgPreview.src = item.image;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.style.display = 'none';
            }

            document.getElementById('publish-btn').querySelector('span').innerText = "Update Article";
            document.querySelector('.cms-panel').scrollTop = 0;
        };

        window.deletePost = (id) => {
            if (confirm("Delete this article?")) {
                newsService.deleteNews(id);
                renderList();
                showToast("Deleted");
            }
        };

        window.resetForm = () => {
            document.getElementById('news-form').reset();
            document.getElementById('post-id').value = '';
            document.getElementById('form-title').innerText = "Create New Article";
            document.getElementById('publish-btn').querySelector('span').innerText = "Publish Now";
            imgContainer.style.display = 'none';
            currentCompressedBase64 = null;
        };

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.borderColor = isError ? '#ff4444' : 'var(--cms-primary)';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>
</body>

</html>