<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIFTHAHUL HUDA MADRASA - Official Portal</title>
    <meta name="description"
        content="Official Student Portal of MIFTHAHUL HUDA MADRASA. Results, News, and Management.">

    <!-- External Fonts & Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ==========================================================================
           CONSOLIDATED CSS DESIGN SYSTEM
           ========================================================================== */
        :root {
            --primary-color: #00f3ff;
            --primary-glow: rgba(0, 243, 255, 0.4);
            --secondary-color: #bc13fe;
            --bg-color: #050505;
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --success: #2ed573;
            --danger: #ff4757;
            --warning: #ffa502;
            --nav-height: 80px;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 5%;
        }

        /* Navigation */
        .global-nav {
            position: fixed;
            top: 0;
            width: 100%;
            height: var(--nav-height);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
        }

        .nav-inner {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            font-size: 1.2rem;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.8;
            transition: 0.3s;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .nav-link:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Hero */
        #hero {
            min-height: 100vh;
            display: flex;
            align-items: center;
            position: relative;
        }

        .hero-content {
            position: relative;
            z-index: 10;
            max-width: 800px;
        }

        .hero-title {
            font-size: clamp(3rem, 10vw, 5rem);
            line-height: 1.1;
            margin-bottom: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, #a5f3fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Sections */
        section {
            padding: 100px 0;
            border-bottom: 1px solid #111;
        }

        .section-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        /* Admin Layout */
        .layout-section {
            display: none;
        }

        .layout-section.active {
            display: block;
        }

        #admin-portal {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: #0a0a0a;
            border-right: 1px solid var(--glass-border);
            padding: 40px 20px;
        }

        .main-content {
            padding: 50px;
            background: #050505;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        /* UI Elements */
        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: #000;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid var(--glass-border);
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            color: #fff;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 15px;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 15px;
            color: #64748b;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #111;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .ph-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: #111;
            border: 1px solid #333;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body data-page-id="home">

    <!-- PUBLIC VIEW -->
    <div id="public-view" class="layout-section active">
        <nav class="global-nav">
            <div class="container nav-inner">
                <a href="#" class="logo">
                    <img src="assets/refont_calligraphic (4).png" alt="" style="height: 32px;">
                    MADRASA PORTAL
                </a>
                <div class="nav-links">
                    <a href="#hero" class="nav-link" data-t="home">Home</a>
                    <a href="#results" class="nav-link" data-t="exam_results">Results</a>
                    <a href="#news" class="nav-link" data-t="latest_updates">News</a>
                    <button onclick="UI.toggleLogin()" class="btn btn-primary btn-sm">
                        <i class="ph ph-shield-check"></i> Admin
                    </button>
                    <!-- Language Switcher placeholder -->
                    <div id="lang-switcher-nav" style="display: flex; gap: 5px;"></div>
                </div>
            </div>
        </nav>

        <section id="hero">
            <canvas id="hero-canvas"
                style="position: absolute; top:0; left:0; width:100%; height:100%; z-index:0;"></canvas>
            <div class="container hero-content">
                <h2 data-t="welcome_to">Welcome to</h2>
                <h1 class="hero-title" data-t="mhmv_title">MIFTHAHUL HUDA MADRASA</h1>
                <p data-t="hero_cta_text" style="color: var(--text-muted); font-size: 1.2rem; margin-bottom: 40px;"></p>
                <div style="display: flex; gap: 20px;">
                    <a href="#results" class="btn btn-primary" data-t="btn_receipt">Check Results</a>
                    <a href="#news" class="btn btn-secondary" data-t="all_news">Latest News</a>
                </div>
            </div>
        </section>

        <section id="results">
            <div class="container">
                <div class="glass-card" style="max-width: 600px;">
                    <h2 class="section-title" data-t="results_title">Student Results</h2>
                    <p data-t="results_desc" style="color: var(--text-muted); margin-bottom: 25px;"></p>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="sr-regno" class="form-input" placeholder="Enter Register No..."
                            style="margin-bottom:0">
                        <button onclick="PublicPortal.search()" class="btn btn-primary">Lookup</button>
                    </div>
                    <div id="sr-status" style="margin-top: 15px; font-size: 0.9rem;"></div>
                    <div id="sr-result-area" style="margin-top: 25px; display: none;"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- ADMIN VIEW -->
    <div id="admin-portal" class="layout-section">
        <aside class="sidebar">
            <div class="logo" style="margin-bottom: 50px;">
                <i class="ph-bold ph-lightning" style="color: var(--primary-color)"></i>
                CONSOLE
            </div>
            <nav style="display: flex; flex-direction: column; gap: 12px;">
                <button class="nav-link active" onclick="Admin.switchPanel('dashboard', this)"><i
                        class="ph ph-grid-four"></i> Overview</button>
                <button class="nav-link" onclick="Admin.switchPanel('sync', this)"><i
                        class="ph ph-arrows-clockwise"></i> Result Sync</button>
                <button class="nav-link" onclick="Admin.switchPanel('schools', this)"><i class="ph ph-buildings"></i>
                    Schools</button>
                <button class="nav-link" onclick="Admin.switchPanel('news', this)"><i class="ph ph-newspaper"></i> News
                    Board</button>
                <hr style="border: none; border-top: 1px solid #222; margin: 15px 0;">
                <button class="nav-link" onclick="UI.logout()" style="color: var(--danger)"><i
                        class="ph ph-sign-out"></i> Logout</button>
            </nav>
        </aside>

        <main class="main-content">
            <div id="panel-dashboard" class="panel active">
                <header style="margin-bottom: 40px;">
                    <h1>System Overview</h1>
                    <p style="color: #64748b;">Live status and administrative controls</p>
                </header>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                    <div class="glass-card">
                        <p style="font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Active School</p>
                        <h2 id="st-active-school" style="margin-top: 10px;">---</h2>
                    </div>
                </div>
            </div>

            <div id="panel-sync" class="panel">
                <header style="margin-bottom: 30px;">
                    <h1>Result Sync Engine</h1>
                    <p style="color: #64748b;">Bridge Google Sheets data to student portal</p>
                </header>

                <div class="glass-card" style="margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px;">
                        <div>
                            <label class="form-label">1. Select Target Exam</label>
                            <select id="sync-exam-id" class="form-input">
                                <option value="">-- Choose Exam Profile --</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">2. Google Sheet ID</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="sync-sheet-id" class="form-input"
                                    placeholder="Paste ID from URL...">
                                <button onclick="SyncEngine.analyze()" class="btn btn-secondary">Analyze</button>
                            </div>
                        </div>
                    </div>

                    <div id="sync-mapping-ui"
                        style="display: none; margin-top: 30px; padding: 25px; background: rgba(0,0,0,0.2); border-radius: 16px; border: 1px dashed #444;">
                        <h3 style="margin-bottom: 20px; font-size: 1.1rem;">Data Mapping</h3>
                        <div id="mapping-fields" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        </div>
                        <div style="margin-top: 25px;">
                            <label class="form-label">Subject Columns (Select all that apply)</label>
                            <div id="subject-selection-grid"
                                style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; display: flex; align-items: center; gap: 20px;">
                        <button id="btn-sync-trigger" class="btn btn-primary" style="padding: 16px 40px;"
                            onclick="SyncEngine.run()">
                            <i class="ph-bold ph-rocket-launch"></i> SYNC & REFRESH PORTAL
                        </button>
                        <div id="sync-progress" class="hidden">
                            <i class="ph ph-spinner ph-spin" style="font-size: 1.5rem; color: var(--primary-color)"></i>
                        </div>
                        <span id="sync-feedback-text"></span>
                    </div>
                </div>

                <div class="glass-card" style="padding: 0; overflow: hidden;">
                    <table class="data-table" id="results-preview-table">
                        <thead>
                            <tr>
                                <th>Roll</th>
                                <th>Name</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="panel-schools" class="panel">
                <h1>School Configuration</h1>
            </div>
            <div id="panel-news" class="panel">
                <h1>Announcements Manager</h1>
            </div>
        </main>
    </div>

    <!-- AUTH SECTION -->
    <div id="login-overlay" class="hidden"
        style="position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(20px);">
        <div class="glass-card" style="width: 400px; text-align: center;">
            <i class="ph-bold ph-key" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 20px;"></i>
            <h2>System Authentication</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Enter administrative access code</p>
            <input type="password" id="login-pin" maxlength="4" placeholder="••••"
                style="width: 100%; text-align: center; font-size: 3rem; letter-spacing: 15px; background: rgba(255,255,255,0.05); border: 1px solid #333; color: var(--primary-color); padding: 15px; border-radius: 12px; outline: none;">
            <button onclick="Auth.login()" class="btn btn-primary"
                style="width: 100%; margin-top: 30px; padding: 18px;">AUTHORIZE</button>
            <button onclick="UI.toggleLogin()" class="btn btn-secondary"
                style="width: 100%; margin-top: 10px;">CANCEL</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- DATA & LOGIC -->
    <script>
        /* --- I18N DICTIONARY (FULL) --- */
        const I18N = {
            en: {
                home: "Home", services: "Services", gallery: "Gallery", about: "About Us", contact: "Contact",
                booking: "Book Tuition", quick_links: "Quick Links", student_zone: "Student Zone",
                fee_payment: "Fee Payment", exam_results: "Exam Results", achievements: "Achievements",
                poster_builder: "Poster Builder", copyright: "All rights reserved.", welcome_to: "Welcome to",
                mhmv_title: "MIFTHAHUL HUDA MADRASA", address_vengara: "Vengara S S Road",
                hero_cta_text: "A simple reminder that consistent effort and dedication in learning today pave the way for achievement and success in the future.",
                btn_receipt: "Receipt", btn_gallery: "View Gallery", btn_contact: "Contact Us",
                results_title: "Student Results", results_desc: "Verify student performance directly from our official examination database. Enter your Register Number below to view immediate results and standings.",
                programs_title: "Educational Programs", programs_desc: "Our Madrasa offers a range of structured educational programs designed to develop both religious and academic knowledge.",
                latest_updates: "Latest Updates", all_news: "All News", login: "Login", dashboard: "Dashboard", portal: "Portal"
            },
            ml: {
                home: "ഹോം", services: "സേവനങ്ങൾ", gallery: "ഗാലറി", about: "ഞങ്ങളെക്കുറിച്ച്", contact: "ബന്ധപ്പെടുക",
                booking: "ട്യൂഷൻ ബുക്കിംഗ്", quick_links: "ദ്രുത ലിങ്കുകൾ", student_zone: "സ്റ്റുഡന്റ് സോൺ",
                fee_payment: "ഫീസ് പേയ്‌മെന്റ്", exam_results: "പരീക്ഷാ ഫലങ്ങൾ", achievements: "നേട്ടങ്ങൾ",
                poster_builder: "പോസ്റ്റർ ബിൽഡർ", copyright: "എല്ലാ അവകാശങ്ങളും നിക്ഷിപ്തം.", welcome_to: "സ്വാഗതം",
                mhmv_title: "മിഫ്താഹുൽ ഹുദ മദ്റസ", address_vengara: "വേങ്ങര എസ് എസ് റോഡ്",
                hero_cta_text: "ഇന്നത്തെ പഠനത്തിലെ സ്ഥിരമായ പരിശ്രമവും അർപ്പണബോധവും ഭാവിയിലെ നേട്ടങ്ങൾക്കും വിജയത്തിനും വഴിയൊരുക്കുന്നു.",
                btn_receipt: "രസീത്", btn_gallery: "ഗാലറി കാണുക", btn_contact: "ഞങ്ങളെ ബന്ധപ്പെടുക",
                results_title: "വിദ്യാർത്ഥി ഫലങ്ങൾ", results_desc: "ഞങ്ങളുടെ ഔദ്യോഗിക പരീക്ഷാ ഡാറ്റാബേസിൽ നിന്ന് വിദ്യാർത്ഥികളുടെ പ്രകടനം നേരിട്ട് പരിശോധിക്കുക. ഉടനടി ഫലങ്ങൾ കാണുന്നതിന് താഴെ നിങ്ങളുടെ രജിസ്റ്റർ നമ്പർ നൽകുക.",
                programs_title: "വിദ്യാഭ്യാസ പരിപാടികൾ", programs_desc: "മതപരവും അക്കാദമിക് അറിവും വികസിപ്പിക്കുന്നതിനായി രൂപകൽപ്പന ചെയ്ത ഘടനാപരമായ വിദ്യാഭ്യാസ പരിപാടികൾ ഞങ്ങളുടെ മദ്റസ വാഗ്ദാനം ചെയ്യുന്നു.",
                latest_updates: "പുതിയ അപ്‌ഡേറ്റുകൾ", all_news: "എല്ലാ വാർത്തകളും", login: "ലോഗിൻ", dashboard: "ഡാഷ്‌ബോർഡ്", portal: "പോർട്ടൽ"
            },
            ar: {
                home: "الرئيسية", services: "الخدمات", gallery: "المعرض", about: "عن المدرسة", contact: "اتصل بنا",
                booking: "حجز الدروس", quick_links: "روابط سريعة", student_zone: "منطقة الطلاب",
                fee_payment: "دفع الرسوم", exam_results: "نتائج الامتحانات", achievements: "الإنجازات",
                poster_builder: "مصمم البوسترات", copyright: "جميع الحقوق محفوظة.", welcome_to: "مرحباً بكم في",
                mhmv_title: "مدرسة مفتاح الهدى", address_vengara: "فينجارا، طريق إس إس",
                hero_cta_text: "تذكر دائماً أن الجهد المستمر والتفاني في التعلم اليوم يمهد الطريق للإنجاز والنجاح في المستقبل.",
                btn_receipt: "إيصال", btn_gallery: "عرض المعرض", btn_contact: "اتصل بنا",
                results_title: "نتائج الطلاب", results_desc: "تحقق من أداء الطلاب مباشرة من قاعدة بيانات الامتحانات الرسمية الخاصة بنا. أدخل رقم التسجيل الخاص بك أدناه لعرض النتائج الفورية.",
                programs_title: "البرامج التعليمية", programs_desc: "تقدم مدرسة مدراسا مجموعة من البرامج التعليمية المنظمة المصممة لتطوير المعرفة الدينية والأكاديمية على حد سواء.",
                latest_updates: "آخر التحديثات", all_news: "كل الأخبار", login: "تسجيل الدخول", dashboard: "لوحة التحكم", portal: "البوابة"
            }
        };


        /* --- CORE: STORAGE --- */
        const Store = {
            prefix: 'mhm_sa_',
            get(k, d = null) { try { return JSON.parse(localStorage.getItem(this.prefix + k)) || d; } catch (e) { return d; } },
            set(k, v) { localStorage.setItem(this.prefix + k, JSON.stringify(v)); }
        };

        /* --- UI UTILS --- */
        const UI = {
            currentLang: Store.get('lang', 'en'),
            toast(msg, type = 'info') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerHTML = `<span>${msg}</span>`;
                c.appendChild(t);
                setTimeout(() => t.remove(), 4000);
            },
            toggleLogin() { document.getElementById('login-overlay').classList.toggle('hidden'); },
            logout() { Store.set('auth', null); location.reload(); },
            initLang() {
                const s = document.getElementById('lang-switcher-nav');
                ['en', 'ml', 'ar'].forEach(l => {
                    const b = document.createElement('button');
                    b.className = `btn btn-mini btn-secondary ${this.currentLang === l ? 'active' : ''}`;
                    b.textContent = l.toUpperCase();
                    b.onclick = () => { this.currentLang = l; Store.set('lang', l); this.applyLang(); };
                    s.appendChild(b);
                });
                this.applyLang();
            },
            applyLang() {
                const t = I18N[this.currentLang];
                document.querySelectorAll('[data-t]').forEach(el => {
                    const k = el.dataset.t;
                    if (t[k]) el.textContent = t[k];
                });
                document.body.dir = this.currentLang === 'ar' ? 'rtl' : 'ltr';
            }
        };

        /* --- AUTH --- */
        const Auth = {
            login() {
                const p = document.getElementById('login-pin').value;
                if (p === '2026') {
                    Store.set('auth', { active: true, ts: Date.now() });
                    Admin.init();
                } else { UI.toast('Security PIN incorrect', 'error'); }
            }
        };

        /* --- ADMIN ENGINE --- */
        const Admin = {
            init() {
                document.getElementById('public-view').classList.remove('active');
                document.getElementById('admin-portal').classList.add('active');
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('st-active-school').textContent = 'MIFTHAHUL HUDA HQ';
                this.loadExams();
            },
            switchPanel(id, btn) {
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById('panel-' + id).classList.add('active');
                document.querySelectorAll('.admin-sidebar .nav-link').forEach(n => n.classList.remove('active'));
                btn.classList.add('active');
            },
            loadExams() {
                const sel = document.getElementById('sync-exam-id');
                const exams = [{ id: 'e1', name: 'Class 10 - Annual 2026' }, { id: 'e2', name: 'Class 12 - Annual 2026' }];
                exams.forEach(ex => {
                    const opt = document.createElement('option');
                    opt.value = ex.id; opt.textContent = ex.name;
                    sel.appendChild(opt);
                });
            }
        };

        /* --- SYNC ENGINE (CORE LOGIC) --- */
        const SyncEngine = {
            analyzedCols: [],
            async analyze() {
                const sid = document.getElementById('sync-sheet-id').value.trim();
                if (!sid) return UI.toast('Enter a valid Sheet ID');

                try {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json`);
                    const txt = await res.text();
                    const json = JSON.parse(txt.match(/setResponse\(([\s\S]+)\)/)[1]);
                    this.analyzedCols = json.table.cols.map(c => c.label || "Unnamed");
                    this.showMapping();
                } catch (e) { UI.toast('Failed to reach sheet. Is it public?', 'error'); }
            },
            showMapping() {
                const fields = document.getElementById('mapping-fields');
                const grid = document.getElementById('subject-selection-grid');
                document.getElementById('sync-mapping-ui').style.display = 'block';

                fields.innerHTML = `
                    <div><label class="form-label">ID (Roll No)</label><select id="m-roll" class="form-input">${this.analyzedCols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                    <div><label class="form-label">Student Name</label><select id="m-name" class="form-input">${this.analyzedCols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                `;

                grid.innerHTML = this.analyzedCols.map(c => `
                    <label class="btn btn-secondary btn-mini"><input type="checkbox" value="${c}" checked> ${c}</label>
                `).join('');
            },
            async run() {
                const sid = document.getElementById('sync-sheet-id').value.trim();
                const eid = document.getElementById('sync-exam-id').value;
                if (!sid || !eid) return UI.toast('Select exam and sheet first');

                const loader = document.getElementById('sync-progress');
                loader.classList.remove('hidden');

                try {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json`);
                    const txt = await res.text();
                    const json = JSON.parse(txt.match(/setResponse\(([\s\S]+)\)/)[1]);

                    const rollCol = document.getElementById('m-roll').value;
                    const nameCol = document.getElementById('m-name').value;
                    const subs = Array.from(document.querySelectorAll('#subject-selection-grid input:checked')).map(i => i.value);

                    const results = json.table.rows.map(r => {
                        const d = {};
                        r.c.forEach((v, i) => d[json.table.cols[i].label] = v?.v ?? '');
                        return {
                            roll: d[rollCol], name: d[nameCol],
                            marks: subs.reduce((a, s) => { a[s] = d[s]; return a; }, {}),
                            total: subs.reduce((a, s) => a + (Number(d[s]) || 0), 0)
                        };
                    }).filter(r => r.roll && r.name);

                    Store.set(`results_${eid}`, results);
                    this.render(results);
                    UI.toast(`Synced ${results.length} students successfully`, 'success');
                } catch (e) { UI.toast('Sync process failed', 'error'); }
                finally { loader.classList.add('hidden'); }
            },
            render(data) {
                const tb = document.querySelector('#results-preview-table tbody');
                tb.innerHTML = data.slice(0, 10).map(r => `
                    <tr>
                        <td>${r.roll}</td>
                        <td><b>${r.name}</b></td>
                        <td>${r.total}</td>
                        <td><span style="color:var(--success)">Healthy</span></td>
                    </tr>
                `).join('') + (data.length > 10 ? `<tr><td colspan="4" style="text-align:center">... and ${data.length - 10} more</td></tr>` : '');
            }
        };

        /* --- PUBLIC PORTAL LOGIC --- */
        const PublicPortal = {
            search() {
                const r = document.getElementById('sr-regno').value.trim();
                if (!r) return;
                const area = document.getElementById('sr-result-area');
                const status = document.getElementById('sr-status');

                status.textContent = 'Searching local vault...';
                // Simulate lookup across all synced exams
                setTimeout(() => {
                    const allData = ['results_e1', 'results_e2'].map(k => Store.get(k, [])).flat();
                    const match = allData.find(st => String(st.roll) === r);

                    if (match) {
                        status.textContent = 'Result found match!';
                        area.style.display = 'block';
                        area.innerHTML = `
                            <div class="glass-card" style="border-color: var(--primary-color)">
                                <h3>${match.name}</h3>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                                    ${Object.entries(match.marks).map(([s, m]) => `<div>${s}: <b>${m}</b></div>`).join('')}
                                </div>
                                <div style="margin-top:20px; font-weight:700; color:var(--primary-color); border-top:1px solid #333; padding-top:15px;">TOTAL SCORE: ${match.total}</div>
                            </div>
                        `;
                    } else {
                        status.textContent = 'No record found for ID: ' + r;
                        area.style.display = 'none';
                    }
                }, 600);
            }
        };

        /* --- APP BOOTSTRAP --- */
        document.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            UI.initLang();
            const session = Store.get('auth');
            if (session && (Date.now() - session.ts < 86400000)) Admin.init();
        });

        function initThreeJS() {
            const c = document.getElementById('hero-canvas');
            if (!c) return;
            const s = new THREE.Scene();
            const cam = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const ren = new THREE.WebGLRenderer({ canvas: c, alpha: true, antialias: true });
            ren.setSize(window.innerWidth, window.innerHeight);
            cam.position.z = 5;
            const g = new THREE.BufferGeometry();
            const ct = 1500;
            const ps = new Float32Array(ct * 3);
            for (let i = 0; i < ct * 3; i++) ps[i] = (Math.random() - 0.5) * 12;
            g.setAttribute('position', new THREE.BufferAttribute(ps, 3));
            const points = new THREE.Points(g, new THREE.PointsMaterial({ size: 0.015, color: 0x00f3ff, transparent: true, opacity: 0.6 }));
            s.add(points);
            function a() { requestAnimationFrame(a); points.rotation.y += 0.0005; ren.render(s, cam); }
            a();
            window.addEventListener('resize', () => { cam.aspect = window.innerWidth / window.innerHeight; cam.updateProjectionMatrix(); ren.setSize(window.innerWidth, window.innerHeight); });
        }
    </script>
</body>

</html>