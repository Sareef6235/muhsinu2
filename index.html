<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DCD Result Portal | Secure Academic Verification</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-1: #060816;
            --bg-2: #101a38;
            --bg-3: #2b1250;
            --text: #e8ecff;
            --text-dim: #b2bbde;
            --surface: rgba(16, 22, 48, 0.55);
            --surface-strong: rgba(11, 16, 35, 0.85);
            --border: rgba(158, 177, 255, 0.24);
            --glow: rgba(122, 162, 255, 0.35);
            --primary: #6c8bff;
            --primary-2: #8f67ff;
            --success: #2ed49b;
            --danger: #ff6e8b;
            --warning: #ffd166;
            --shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
            --radius: 18px;
            --radius-lg: 24px;
            --container: 1180px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            min-height: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--text);
            background: linear-gradient(120deg, var(--bg-1), var(--bg-2), var(--bg-3), var(--bg-1));
            background-size: 220% 220%;
            animation: bgShift 18s ease infinite;
            overflow-x: hidden;
        }

        @keyframes bgShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .bg-particles {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            filter: blur(1px);
            opacity: 0.35;
            animation: floatUp linear infinite;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.85), rgba(108, 139, 255, 0.06));
        }

        @keyframes floatUp {
            from { transform: translateY(115vh) translateX(0); }
            to { transform: translateY(-15vh) translateX(18px); }
        }

        a { color: inherit; text-decoration: none; }

        .wrapper {
            max-width: var(--container);
            margin: 0 auto;
            padding: 0 18px;
        }

        .glass {
            background: var(--surface);
            border: 1px solid var(--border);
            backdrop-filter: blur(16px);
            box-shadow: var(--shadow);
        }

        .navbar {
            position: sticky;
            top: 14px;
            z-index: 50;
            margin: 16px auto;
            border-radius: 999px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            letter-spacing: 0.3px;
        }

        .brand-badge {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: linear-gradient(140deg, var(--primary), var(--primary-2));
            box-shadow: 0 0 18px var(--glow);
            display: grid;
            place-items: center;
            font-size: 14px;
            font-weight: 900;
        }

        .nav-links {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dim);
        }

        .nav-links a {
            padding: 8px 12px;
            border-radius: 999px;
            transition: .2s ease;
        }

        .nav-links a:hover,
        .nav-links a:focus-visible {
            color: var(--text);
            background: rgba(255, 255, 255, 0.08);
            outline: none;
        }

        .network-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 7px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: .3px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            background: rgba(11, 16, 35, 0.6);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
        }

        .offline .dot {
            background: var(--danger);
            box-shadow: 0 0 12px var(--danger);
        }

        .hero {
            margin: 36px auto 26px;
            padding: 44px 26px;
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .hero::before,
        .hero::after {
            content: "";
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            pointer-events: none;
        }

        .hero::before {
            width: 320px;
            height: 320px;
            background: rgba(108, 139, 255, 0.28);
            top: -130px;
            right: -120px;
        }

        .hero::after {
            width: 240px;
            height: 240px;
            background: rgba(143, 103, 255, 0.25);
            bottom: -90px;
            left: -70px;
        }

        .hero h1 {
            margin: 0;
            font-size: clamp(2rem, 4.5vw, 3.8rem);
            line-height: 1.05;
            letter-spacing: -1.4px;
            text-wrap: balance;
        }

        .hero p {
            max-width: 720px;
            margin: 16px 0 0;
            color: var(--text-dim);
            font-size: clamp(1rem, 2vw, 1.1rem);
        }

        .hero-actions {
            margin-top: 26px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            border: 0;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 700;
            cursor: pointer;
            transition: .2s ease;
            font-size: 14px;
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: .75;
        }

        .btn-primary {
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-2));
            box-shadow: 0 12px 24px rgba(79, 94, 180, 0.45);
        }

        .btn-primary:hover { transform: translateY(-1px); }

        .btn-ghost {
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.26);
            background: rgba(255, 255, 255, 0.05);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1.45fr 1fr;
            gap: 18px;
            align-items: start;
        }

        .panel {
            border-radius: var(--radius);
            padding: 22px;
            margin-bottom: 18px;
        }

        .panel h2,
        .panel h3 {
            margin: 0 0 14px;
            font-size: 1.16rem;
            letter-spacing: -0.3px;
        }

        .panel p {
            margin: 0;
            color: var(--text-dim);
        }

        .field {
            margin-top: 14px;
            display: grid;
            gap: 8px;
        }

        .field label {
            font-size: 12px;
            letter-spacing: .5px;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
        }

        .input {
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.22);
            background: rgba(8, 11, 24, 0.72);
            color: var(--text);
            padding: 12px 13px;
            font-size: 14px;
        }

        .input:focus {
            outline: 2px solid rgba(108, 139, 255, 0.32);
            border-color: rgba(108, 139, 255, 0.52);
        }

        .split {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr 1fr;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            margin-top: 14px;
        }

        .metric {
            border-radius: 14px;
            padding: 14px;
            background: rgba(7, 10, 22, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.13);
        }

        .metric small {
            display: block;
            color: var(--text-dim);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: .3px;
        }

        .metric strong {
            font-size: 1.1rem;
            letter-spacing: -.2px;
        }

        .status {
            min-height: 22px;
            margin-top: 12px;
            font-weight: 700;
            font-size: 14px;
        }

        .list {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 10px;
        }

        .list li {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(8, 11, 24, 0.5);
        }

        .list strong { display: block; margin-bottom: 6px; }

        .admin-cta {
            margin-top: 16px;
            width: 100%;
        }

        .hidden { display: none !important; }

        .toasts {
            position: fixed;
            top: 90px;
            right: 16px;
            z-index: 99;
            display: grid;
            gap: 10px;
            max-width: min(90vw, 340px);
        }

        .toast {
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 13px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(10, 14, 30, 0.92);
            color: var(--text);
            animation: toastIn .25s ease;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast.success { border-color: rgba(46, 212, 155, 0.5); }
        .toast.error { border-color: rgba(255, 110, 139, 0.6); }
        .toast.info { border-color: rgba(108, 139, 255, 0.65); }

        .loader-wrap {
            position: fixed;
            inset: 0;
            z-index: 90;
            display: none;
            place-items: center;
            background: rgba(2, 5, 15, 0.55);
            backdrop-filter: blur(7px);
        }

        .loader-wrap.active { display: grid; }

        .loader {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.14);
            border-top-color: #88a4ff;
            animation: spin .8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 70;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: rgba(6, 9, 18, 0.72);
            backdrop-filter: blur(10px);
        }

        .modal.active { display: flex; }

        .modal-card {
            width: min(430px, 100%);
            border-radius: 20px;
            padding: 22px;
            position: relative;
        }

        .close-x {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            width: 30px;
            height: 30px;
            border-radius: 10px;
            cursor: pointer;
        }

        .admin-shell {
            border-radius: var(--radius-lg);
            margin-top: 14px;
            display: none;
            overflow: hidden;
            grid-template-columns: 250px 1fr;
            min-height: 390px;
        }

        .admin-shell.active { display: grid; }

        .sidebar {
            border-right: 1px solid rgba(255, 255, 255, 0.14);
            padding: 20px 16px;
            background: rgba(6, 9, 20, 0.78);
        }

        .side-title {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: .95rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .side-list {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 8px;
        }

        .side-list li {
            padding: 10px 11px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.02);
            font-weight: 600;
            color: var(--text-dim);
        }

        .admin-main {
            padding: 18px;
            display: grid;
            gap: 12px;
            background: rgba(10, 15, 34, 0.65);
        }

        .admin-metrics {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }


        .split-top {
            margin-top: 12px;
        }

        .upload-panel {
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.16);
        }

        .upload-title {
            margin-bottom: 10px;
        }

        .qr-caption {
            display: block;
            margin-top: 6px;
            color: #5c6f9f;
            font-weight: 600;
        }

        .modal-title {
            margin-top: 0;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            margin: 0;
            color: var(--text-dim);
        }

        .security-note {
            margin-top: 14px;
            font-size: 12px;
            color: #95f8d1;
        }

        #certificateArea {
            position: fixed;
            inset: 0;
            z-index: 80;
            background: rgba(2, 4, 12, 0.78);
            backdrop-filter: blur(8px);
            padding: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        #certificateArea.active { display: flex; }

        #certificate {
            width: min(100%, 900px);
            background: #fff;
            color: #1b2142;
            border-radius: 8px;
            border: 16px solid #f8fafc;
            outline: 2px solid #d0d9f7;
            box-shadow: 0 30px 85px rgba(0, 0, 0, 0.35);
            padding: 34px;
            position: relative;
        }

        .cert-watermark {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            pointer-events: none;
            font-size: clamp(58px, 9vw, 110px);
            font-weight: 800;
            letter-spacing: 8px;
            color: rgba(41, 68, 139, 0.07);
            transform: rotate(-18deg);
            user-select: none;
        }

        .cert-header {
            display: grid;
            grid-template-columns: 90px 1fr 90px;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e5ebfb;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .logo-placeholder,
        .stamp-placeholder {
            width: 84px;
            height: 84px;
            border: 2px dashed #c4d0f4;
            border-radius: 50%;
            display: grid;
            place-items: center;
            color: #7084bb;
            font-size: 11px;
            text-align: center;
            font-weight: 700;
            line-height: 1.25;
        }

        .cert-title {
            text-align: center;
        }

        .cert-title h3 {
            margin: 0;
            font-size: 30px;
            color: #1b3268;
            letter-spacing: .5px;
        }

        .cert-title p {
            margin: 6px 0 0;
            color: #55648d;
            font-weight: 600;
            font-size: 14px;
        }

        .candidate {
            margin: 14px 0;
            padding: 14px;
            background: #f7f9ff;
            border: 1px solid #dae3ff;
            border-radius: 10px;
            display: grid;
            gap: 8px;
        }

        .candidate span { font-weight: 700; }

        .cert-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .cert-table th,
        .cert-table td {
            border: 1px solid #dce5ff;
            padding: 10px;
            font-size: 14px;
        }

        .cert-table th {
            background: #f2f6ff;
            text-align: left;
            color: #30457d;
        }

        .cert-total {
            margin-top: 14px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            font-size: 20px;
            font-weight: 800;
            color: #1f3469;
        }

        .cert-foot {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: end;
            gap: 10px;
            border-top: 1px dashed #d2dbf7;
            padding-top: 12px;
        }

        .signature {
            text-align: center;
            min-width: 160px;
            font-size: 12px;
            color: #50618f;
            font-weight: 700;
        }

        .signature .line {
            border-top: 2px solid #c9d5f8;
            margin-bottom: 6px;
            height: 30px;
        }

        #qrcode {
            width: 90px;
            height: 90px;
            display: grid;
            place-items: center;
        }

        .cert-actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        footer {
            margin: 26px 0 16px;
            border-radius: var(--radius);
            padding: 18px;
            display: grid;
            gap: 8px;
            text-align: center;
            font-size: 13px;
            color: var(--text-dim);
        }

        @media (max-width: 980px) {
            .main-grid { grid-template-columns: 1fr; }
            .admin-shell.active { grid-template-columns: 1fr; }
            .sidebar { border-right: 0; border-bottom: 1px solid rgba(255, 255, 255, 0.14); }
        }

        @media (max-width: 720px) {
            .navbar { border-radius: 16px; }
            .nav-links { gap: 8px; font-size: 12px; }
            .meta-grid,
            .admin-metrics,
            .split { grid-template-columns: 1fr; }
            .hero { padding: 30px 18px; }
            #certificate { padding: 16px; border-width: 8px; }
            .cert-header { grid-template-columns: 1fr; }
            .logo-placeholder,
            .stamp-placeholder { width: 68px; height: 68px; margin: 0 auto; }
            .cert-title h3 { font-size: 22px; }
            .cert-foot { flex-direction: column; align-items: flex-start; }
            .toasts { top: 76px; right: 10px; }
        }

        @media print {
            body * { visibility: hidden; }
            #certificate,
            #certificate * { visibility: visible; }
            #certificate {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                min-height: 297mm;
                margin: 0;
                box-shadow: none;
                border: 10px solid #f8fafc;
                outline: 2px solid #d0d9f7;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <div class="bg-particles" id="particles"></div>

    <div class="wrapper">
        <nav class="navbar glass" aria-label="Main navigation">
            <a href="#home" class="brand" aria-label="DCD Portal Home">
                <span class="brand-badge">DCD</span>
                <span>Result Portal</span>
            </a>
            <div class="nav-links">
                <a href="#home">Home</a>
                <a href="#verify">Verify Result</a>
                <a href="#admin">Admin</a>
                <a href="#about">About</a>
                <span class="network-chip" id="networkChip"><span class="dot"></span><span id="networkText">Online</span></span>
            </div>
        </nav>

        <header id="home" class="hero glass">
            <h1>Secure Academic Result Verification for Modern Institutions</h1>
            <p>
                A professional SaaS-grade education verification experience with tamper-aware records, cloud synchronization,
                and certificate-grade output optimized for institutions and students.
            </p>
            <div class="hero-actions">
                <a class="btn btn-primary" href="#verify">Start Verification</a>
                <a class="btn btn-ghost" href="#about">Learn More</a>
            </div>
        </header>

        <main class="main-grid">
            <section>
                <article id="verify" class="panel glass">
                    <h2>Result Verification</h2>
                    <p>Enter the official roll number to validate and view certified result documents.</p>
                    <div class="field">
                        <label for="rollInput">Roll Number</label>
                        <input type="text" id="rollInput" class="input" placeholder="e.g. 000001" inputmode="numeric" maxlength="24" />
                    </div>
                    <div class="split split-top">
                        <button class="btn btn-primary" id="searchBtn">Verify Result</button>
                        <button class="btn btn-ghost" id="clearBtn" type="button">Clear</button>
                    </div>
                    <div id="searchMsg" class="status" aria-live="polite"></div>
                </article>

                <article id="about" class="panel glass">
                    <h3>About Institution</h3>
                    <ul class="list">
                        <li>
                            <strong>Academic Trust</strong>
                            We provide authenticated mark records and transparent verification workflows.
                        </li>
                        <li>
                            <strong>Cloud Reliability</strong>
                            Built for Render deployment, MongoDB compatibility, and Supabase-ready integration paths.
                        </li>
                        <li>
                            <strong>Student-first Access</strong>
                            Fast certificate generation and mobile-ready view for public and administrative users.
                        </li>
                    </ul>
                </article>

                <article class="panel glass">
                    <h3>Security & Authenticity</h3>
                    <ul class="list">
                        <li><strong>Endpoint Integrity</strong>Securely interacts with institutional APIs for results and deploy checks.</li>
                        <li><strong>Sanitized Rendering</strong>Escaped dynamic fields to reduce XSS risk in generated tables and certificate areas.</li>
                        <li><strong>Verification QR</strong>Certificate QR references active portal location for validation lookup workflow.</li>
                    </ul>
                </article>
            </section>

            <aside id="admin" class="panel glass">
                <h3>Admin Access</h3>
                <p>Administrative actions are locked behind secure authorization.</p>
                <button id="openAdminModal" class="btn btn-primary admin-cta" type="button">Open Admin Panel</button>

                <div id="adminShell" class="admin-shell glass" aria-live="polite">
                    <div class="sidebar">
                        <h4 class="side-title">Dashboard</h4>
                        <ul class="side-list">
                            <li>Data Sync</li>
                            <li>JSON Upload</li>
                            <li>Deployment Logs</li>
                            <li>Session Controls</li>
                        </ul>
                        <p class="security-note">Admin visibility restricted until authenticated.</p>
                    </div>

                    <div class="admin-main">
                        <div class="admin-metrics">
                            <div class="metric"><small>Total Records</small><strong id="totalRecords">0</strong></div>
                            <div class="metric"><small>Last Deploy</small><strong id="lastDeploy">Never</strong></div>
                            <div class="metric"><small>System Status</small><strong id="systemStatus">Checking...</strong></div>
                        </div>

                        <div class="panel upload-panel">
                            <h3 class="upload-title">JSON Upload</h3>
                            <div class="field">
                                <label for="jsonInput">Upload Data File (.json)</label>
                                <input type="file" id="jsonInput" accept="application/json,.json" class="input" />
                            </div>
                            <div class="split split-top">
                                <button class="btn btn-primary" id="deployBtn" type="button">Deploy to Cloud</button>
                                <button class="btn btn-ghost" id="logoutBtn" type="button">Logout</button>
                            </div>
                            <div id="uploadStatus" class="status" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </aside>
        </main>

        <footer class="glass">
            <div>© <span id="year"></span> DCD Education Technology. All rights reserved.</div>
            <div>Contact: support@dcd-portal.edu · Secure Verification Infrastructure</div>
        </footer>
    </div>

    <div id="certificateArea" aria-modal="true" role="dialog" aria-label="Result Certificate">
        <section id="certificate">
            <div class="cert-watermark">VERIFIED</div>
            <div class="cert-header">
                <div class="logo-placeholder">INSTITUTION<br />LOGO</div>
                <div class="cert-title">
                    <h3 id="certSchool">Institution Name</h3>
                    <p id="certExam">Official Examination Result Certificate</p>
                </div>
                <div class="stamp-placeholder">STAMP<br />AREA</div>
            </div>

            <div class="candidate">
                <div><strong>Candidate Name:</strong> <span id="certName">-</span></div>
                <div><strong>Roll Number:</strong> <span id="certRoll">-</span></div>
            </div>

            <div id="certTableArea"></div>
            <div class="cert-total"><span>Total:</span><span id="certTotal">0</span></div>

            <div class="cert-foot">
                <div>
                    <div id="qrcode"></div>
                    <small class="qr-caption">Verification QR</small>
                </div>
                <div class="signature">
                    <div class="line"></div>
                    Authorized Signature
                </div>
            </div>

            <div class="cert-actions" id="certActions">
                <button class="btn btn-primary" id="downloadBtn" type="button">Download PDF</button>
                <button class="btn btn-ghost" id="closeCertBtn" type="button">Close</button>
            </div>
        </section>
    </div>

    <div id="adminModal" class="modal" aria-modal="true" role="dialog" aria-label="Admin Login">
        <div class="modal-card glass">
            <button class="close-x" id="closeAdminModal" type="button" aria-label="Close">✕</button>
            <h3 class="modal-title">Administrator Sign In</h3>
            <p class="modal-subtitle">Authorized personnel only.</p>
            <div class="field">
                <label for="adminPass">Administrative Key</label>
                <input type="password" id="adminPass" class="input" autocomplete="current-password" placeholder="••••••••" />
            </div>
            <div class="split split-top">
                <button class="btn btn-primary" id="loginBtn" type="button">Authenticate</button>
                <button class="btn btn-ghost" id="cancelLoginBtn" type="button">Cancel</button>
            </div>
            <div id="loginStatus" class="status" aria-live="polite"></div>
        </div>
    </div>

    <div class="loader-wrap" id="loaderWrap"><div class="loader" aria-label="Loading"></div></div>
    <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

    <script>
        const App = {
            config: {
                API: window.location.origin,
                ADMIN_PASS: "1234"
            },
            state: {
                data: [],
                authenticated: false,
                lastDeploy: "Never"
            },
            els: {},

            init() {
                this.cacheElements();
                this.bindEvents();
                this.renderParticles();
                this.syncNetworkState();
                this.restoreData();
                this.setYear();
                this.healthCheck();
                this.updateMetrics();
            },

            cacheElements() {
                const byId = (id) => document.getElementById(id);
                this.els = {
                    openAdminModal: byId("openAdminModal"),
                    adminModal: byId("adminModal"),
                    closeAdminModal: byId("closeAdminModal"),
                    cancelLoginBtn: byId("cancelLoginBtn"),
                    loginBtn: byId("loginBtn"),
                    loginStatus: byId("loginStatus"),
                    adminPass: byId("adminPass"),
                    adminShell: byId("adminShell"),
                    deployBtn: byId("deployBtn"),
                    logoutBtn: byId("logoutBtn"),
                    jsonInput: byId("jsonInput"),
                    uploadStatus: byId("uploadStatus"),
                    searchBtn: byId("searchBtn"),
                    clearBtn: byId("clearBtn"),
                    rollInput: byId("rollInput"),
                    searchMsg: byId("searchMsg"),
                    certificateArea: byId("certificateArea"),
                    certSchool: byId("certSchool"),
                    certExam: byId("certExam"),
                    certRoll: byId("certRoll"),
                    certName: byId("certName"),
                    certTableArea: byId("certTableArea"),
                    certTotal: byId("certTotal"),
                    certificate: byId("certificate"),
                    qrcode: byId("qrcode"),
                    closeCertBtn: byId("closeCertBtn"),
                    downloadBtn: byId("downloadBtn"),
                    loaderWrap: byId("loaderWrap"),
                    toasts: byId("toasts"),
                    networkChip: byId("networkChip"),
                    networkText: byId("networkText"),
                    totalRecords: byId("totalRecords"),
                    lastDeploy: byId("lastDeploy"),
                    systemStatus: byId("systemStatus"),
                    particles: byId("particles"),
                    year: byId("year")
                };
            },

            bindEvents() {
                this.els.openAdminModal.addEventListener("click", () => this.openAdminModal());
                this.els.closeAdminModal.addEventListener("click", () => this.closeAdminModal());
                this.els.cancelLoginBtn.addEventListener("click", () => this.closeAdminModal());
                this.els.loginBtn.addEventListener("click", () => this.adminLogin());
                this.els.deployBtn.addEventListener("click", () => this.deploy());
                this.els.logoutBtn.addEventListener("click", () => this.logout());
                this.els.jsonInput.addEventListener("change", (e) => this.uploadJSON(e));
                this.els.searchBtn.addEventListener("click", () => this.search());
                this.els.clearBtn.addEventListener("click", () => this.clearSearch());
                this.els.rollInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") this.search();
                });
                this.els.downloadBtn.addEventListener("click", () => this.downloadPDF());
                this.els.closeCertBtn.addEventListener("click", () => this.closeCert());

                window.addEventListener("online", () => this.syncNetworkState());
                window.addEventListener("offline", () => this.syncNetworkState());
                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        this.closeAdminModal();
                        this.closeCert();
                    }
                });
            },

            openAdminModal() {
                this.els.loginStatus.textContent = "";
                this.els.adminPass.value = "";
                this.els.adminModal.classList.add("active");
                this.els.adminPass.focus();
            },

            closeAdminModal() {
                this.els.adminModal.classList.remove("active");
            },

            setYear() {
                this.els.year.textContent = String(new Date().getFullYear());
            },

            renderParticles() {
                const frag = document.createDocumentFragment();
                for (let i = 0; i < 28; i += 1) {
                    const p = document.createElement("span");
                    p.className = "particle";
                    const size = Math.floor(Math.random() * 6) + 4;
                    p.style.width = `${size}px`;
                    p.style.height = `${size}px`;
                    p.style.left = `${Math.random() * 100}%`;
                    p.style.animationDuration = `${Math.random() * 18 + 10}s`;
                    p.style.animationDelay = `${Math.random() * 10}s`;
                    frag.appendChild(p);
                }
                this.els.particles.appendChild(frag);
            },

            showLoader(show = true) {
                this.els.loaderWrap.classList.toggle("active", show);
            },

            toast(message, type = "info") {
                const toast = document.createElement("div");
                toast.className = `toast ${type}`;
                toast.textContent = message;
                this.els.toasts.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3500);
            },

            syncNetworkState() {
                const isOnline = navigator.onLine;
                this.els.networkChip.classList.toggle("offline", !isOnline);
                this.els.networkText.textContent = isOnline ? "Online" : "Offline";
            },

            restoreData() {
                const stored = localStorage.getItem("examData");
                if (!stored) return;
                try {
                    const parsed = JSON.parse(stored);
                    this.state.data = Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    localStorage.removeItem("examData");
                }
            },

            sanitizeText(value) {
                return String(value ?? "")
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\"/g, "&quot;")
                    .replace(/'/g, "&#39;");
            },

            setStatus(el, message, tone = "info") {
                const colorMap = {
                    info: "var(--text-dim)",
                    success: "var(--success)",
                    error: "var(--danger)",
                    warning: "var(--warning)"
                };
                el.textContent = message;
                el.style.color = colorMap[tone] || colorMap.info;
            },

            validateRoll(roll) {
                return /^[a-zA-Z0-9\-_/]{1,24}$/.test(roll);
            },

            adminLogin() {
                const pass = this.els.adminPass.value;
                if (pass === this.config.ADMIN_PASS) {
                    this.state.authenticated = true;
                    this.els.adminShell.classList.add("active");
                    this.closeAdminModal();
                    this.toast("Admin authentication successful.", "success");
                    this.updateMetrics();
                } else {
                    this.setStatus(this.els.loginStatus, "Invalid administrative key.", "error");
                    this.toast("Authorization failed.", "error");
                }
            },

            logout() {
                localStorage.removeItem("examData");
                this.state.data = [];
                this.state.authenticated = false;
                this.state.lastDeploy = "Never";
                this.els.adminShell.classList.remove("active");
                this.setStatus(this.els.uploadStatus, "Admin session terminated.", "warning");
                this.updateMetrics();
                this.toast("Logged out and local buffer cleared.", "info");
            },

            uploadJSON(e) {
                if (!this.state.authenticated) {
                    this.toast("Authenticate to upload data.", "error");
                    return;
                }
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const raw = JSON.parse(event.target?.result || "[]");
                        this.state.data = Array.isArray(raw) ? raw : (raw.exams?.[0]?.results || []);
                        localStorage.setItem("examData", JSON.stringify(this.state.data));
                        this.setStatus(this.els.uploadStatus, `Loaded ${this.state.data.length} records into local buffer.`, "success");
                        this.updateMetrics();
                        this.toast("JSON loaded successfully.", "success");
                    } catch (err) {
                        this.setStatus(this.els.uploadStatus, "Registry parse error. Please provide valid JSON.", "error");
                        this.toast("Invalid JSON file.", "error");
                    }
                };
                reader.readAsText(file);
            },

            async healthCheck() {
                try {
                    const res = await fetch(`${this.config.API}/health`);
                    const json = await res.json();
                    const up = !!(json && (json.ok || json.status));
                    this.els.systemStatus.textContent = up ? "Healthy" : "Degraded";
                    this.els.systemStatus.style.color = up ? "var(--success)" : "var(--warning)";
                } catch (e) {
                    this.els.systemStatus.textContent = "Offline";
                    this.els.systemStatus.style.color = "var(--danger)";
                }
            },

            updateMetrics() {
                this.els.totalRecords.textContent = String(this.state.data?.length || 0);
                this.els.lastDeploy.textContent = this.state.lastDeploy;
            },

            async deploy() {
                if (!this.state.authenticated) {
                    this.toast("Authentication required for deploy.", "error");
                    return;
                }
                if (!this.state.data || !this.state.data.length) {
                    this.toast("System state is empty: capture JSON first.", "error");
                    return;
                }

                const payload = { exams: [{ examId: "dcd_pro_sync", results: this.state.data }] };
                this.setStatus(this.els.uploadStatus, "Transmitting to cloud nodes...", "info");
                this.showLoader(true);

                try {
                    const res = await fetch(`${this.config.API}/deploy`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const text = await res.text();
                    let response;
                    try {
                        response = JSON.parse(text);
                    } catch {
                        throw new Error("Server returned corrupt data stream");
                    }
                    if (!res.ok) throw new Error(response.message || "Cloud handshake failure");

                    this.state.lastDeploy = new Date().toLocaleString();
                    this.setStatus(this.els.uploadStatus, `Cloud sync successful. Records: ${response.count ?? 0}`, "success");
                    this.updateMetrics();
                    this.toast("Cloud deployment completed.", "success");
                } catch (err) {
                    console.error("Cloud Error:", err);
                    this.setStatus(this.els.uploadStatus, `Sync failed: ${err.message}`, "error");
                    this.toast("Cloud sync interrupted.", "error");
                } finally {
                    this.showLoader(false);
                }
            },

            clearSearch() {
                this.els.rollInput.value = "";
                this.setStatus(this.els.searchMsg, "", "info");
            },

            async search() {
                const roll = this.els.rollInput.value.trim();
                if (!roll) {
                    this.setStatus(this.els.searchMsg, "Roll number is required.", "warning");
                    return;
                }
                if (!this.validateRoll(roll)) {
                    this.setStatus(this.els.searchMsg, "Invalid roll number format.", "error");
                    return;
                }

                this.setStatus(this.els.searchMsg, "Deciphering cloud records...", "info");
                this.showLoader(true);

                try {
                    const res = await fetch(`${this.config.API}/results`);
                    const text = await res.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        throw new Error("Data stream unreadable");
                    }

                    const records = data.exams?.[0]?.results || [];
                    const found = records.find((r) => {
                        const a = String(r.roll ?? "");
                        const b = String(r["Roll Number"] ?? "");
                        const c = String(r.Roll ?? "");
                        return a === roll || b === roll || c === roll;
                    });

                    if (found) {
                        this.setStatus(this.els.searchMsg, "Verified. Record found.", "success");
                        this.toast("Result verified.", "success");
                        this.renderCertificate(found);
                    } else {
                        this.setStatus(this.els.searchMsg, "No matching record found.", "error");
                        this.toast("Record not found.", "error");
                    }
                } catch (err) {
                    console.error("Fetch Error:", err);
                    this.setStatus(this.els.searchMsg, "Node offline. Connection restricted.", "error");
                    this.toast("Unable to fetch records.", "error");
                } finally {
                    this.showLoader(false);
                }
            },

            renderCertificate(record) {
                const school = this.sanitizeText(record.School || record.school || "ENTERPRISE INSTITUTION");
                const exam = this.sanitizeText(record.Exam || record.exam || "OFFICIAL SYSTEM RECORD");
                const roll = this.sanitizeText(record.roll || record.Roll || record["Roll Number"] || "-");
                const name = this.sanitizeText(record.name || record.Name || record["Student Name"] || "ANONYMOUS");

                this.els.certSchool.textContent = school;
                this.els.certExam.textContent = exam;
                this.els.certRoll.textContent = roll;
                this.els.certName.textContent = name;

                let rows = "";
                let total = 0;
                if (record.subjects && typeof record.subjects === "object" && !Array.isArray(record.subjects)) {
                    Object.entries(record.subjects).forEach(([sub, mark]) => {
                        const safeSub = this.sanitizeText(sub).toUpperCase();
                        const safeMark = this.sanitizeText(mark);
                        total += Number(mark) || 0;
                        rows += `<tr><td>${safeSub}</td><td>${safeMark}</td></tr>`;
                    });
                } else if (record.Subjects && Array.isArray(record.Subjects)) {
                    record.Subjects.forEach((s) => {
                        const subject = this.sanitizeText(s.Subject || "N/A").toUpperCase();
                        const marks = this.sanitizeText(s.Marks);
                        total += Number(s.Marks) || 0;
                        rows += `<tr><td>${subject}</td><td>${marks}</td></tr>`;
                    });
                }

                const table = `
                    <table class="cert-table">
                        <thead><tr><th>Subject</th><th>Marks</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
                this.els.certTableArea.innerHTML = table;
                this.els.certTotal.textContent = this.sanitizeText(record.total || total);

                this.els.qrcode.innerHTML = "";
                new QRCode(this.els.qrcode, {
                    text: `${location.origin}/results?roll=${encodeURIComponent(roll)}`,
                    width: 82,
                    height: 82
                });

                this.els.certificateArea.classList.add("active");
            },

            closeCert() {
                this.els.certificateArea.classList.remove("active");
            },

            downloadPDF() {
                const opt = {
                    margin: [6, 6, 6, 6],
                    filename: `Result_${Date.now()}.pdf`,
                    image: { type: "jpeg", quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
                };
                html2pdf().set(opt).from(this.els.certificate).save();
            }
        };

        window.addEventListener("load", () => App.init());
    </script>
</body>

</html>
