<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Exam Admin Panel | MIFTHAHUL HUDA</title>

    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* Theme Variables matching existing dashboard */
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --bg: #050505;
            --surface: #0a0a0a;
            --sidebar-width: 280px;
            --text-main: #ffffff;
            --text-muted: #888888;
            --border: #222;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --success: #2ed573;
            --danger: #ff4757;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        #proExamSidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-logo {
            padding: 30px;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
        }

        .school-select-container {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        #active-school-selector {
            width: 100%;
            padding: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-main);
            outline: none;
            font-family: inherit;
            cursor: pointer;
        }

        #active-school-selector option {
            background: #000;
        }

        nav {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
            transition: 0.2s;
            font-weight: 500;
        }

        .nav-item:hover {
            color: var(--text-main);
            background: var(--glass-bg);
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(0, 243, 255, 0.1);
            /* transparent primary */
            font-weight: 600;
        }

        .nav-item i {
            font-size: 1.2rem;
        }

        /* Logout specially styled */
        .nav-logout {
            margin-top: auto;
            color: var(--danger);
        }

        .nav-logout:hover {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
        }

        /* --- MAIN CONTENT --- */
        #panelContainer {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 40px;
            width: calc(100% - var(--sidebar-width));
        }

        /* Responsive Sidebar Toggle */
        @media (max-width: 768px) {
            #proExamSidebar {
                transform: translateX(-100%);
            }

            #proExamSidebar.open {
                transform: translateX(0);
            }

            #panelContainer {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }

            .mobile-toggle {
                display: block;
            }
        }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 6px;
        }

        /* --- PANELS --- */
        .panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        /* Interactive Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-val {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #fff;
            font-family: inherit;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 243, 255, 0.2);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-muted);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .login-box {
            max-width: 400px;
            width: 90%;
            margin: 100px auto;
            text-align: center;
            padding: 40px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #public-view {
            display: none;
            /* Hidden by default if admin is logged in */
            width: 100%;
            height: 100vh;
            overflow-y: auto;
        }

        #admin-view {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }
    </style>
</head>

<body>

    <!-- ================= PUBLIC VIEW ================= -->
    <div id="public-view">
        <div class="login-box">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;">
                <i class="ph-bold ph-student"></i>
            </div>
            <h2 style="margin-bottom: 5px;">Result Portal</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Enter your details to view result</p>

            <div class="card" style="text-align: left;">
                <label
                    style="font-size: 0.8rem; font-weight: bold; color: #666; display: block; margin-bottom: 5px;">Register/Roll
                    Number</label>
                <input type="text" id="publicRegInput" class="form-control" placeholder="e.g. 4029">
                <button class="btn btn-primary"
                    style="width: 100%; justify-content: center; padding: 12px; margin-top: 10px;"
                    onclick="proExamApp.publicSearch()">
                    View Result
                </button>
            </div>

            <div id="public-msg" style="margin-top: 15px; color: var(--danger);"></div>
            <p style="margin-top: 20px; font-size: 0.8rem; color: #444;" onclick="proExamApp.toggleView('admin')">Admin
                Access</p>
        </div>
    </div>

    <!-- ================= ADMIN VIEW ================= -->
    <div id="admin-view">







        <!-- Mobile Toggle -->
        <button class="mobile-toggle" onclick="document.getElementById('proExamSidebar').classList.toggle('open')">
            <i class="ph-bold ph-list"></i>
        </button>

        <!-- SIDEBAR -->
        <aside id="proExamSidebar">
            <div class="sidebar-logo">
                <i class="ph-bold ph-shield-check"></i> PRO EXAM
            </div>

            <div class="school-select-container">
                <label style="margin-bottom:5px; font-size:0.8rem;">Active School</label>
                <select id="active-school-selector" onchange="proExamApp.switchSchool(this.value)">
                    <!-- Populated by JS -->
                </select>
            </div>

            <nav>
                <div class="nav-item active" onclick="proExamApp.nav('dashboard', this)">
                    <i class="ph-bold ph-squares-four"></i> Dashboard
                </div>
                <div class="nav-item" onclick="proExamApp.nav('upload', this)">
                    <i class="ph-bold ph-upload-simple"></i> Upload Results
                </div>
                <div class="nav-item" onclick="proExamApp.nav('certificate', this)">
                    <i class="ph-bold ph-certificate"></i> Certificate
                </div>
                <div class="nav-item" onclick="proExamApp.nav('signature', this)">
                    <i class="ph-bold ph-signature"></i> Signature
                </div>
                <div class="nav-item" onclick="proExamApp.nav('analytics', this)">
                    <i class="ph-bold ph-chart-pie-slice"></i> Analytics
                </div>
                <div class="nav-item" onclick="proExamApp.nav('schools', this)">
                    <i class="ph-bold ph-buildings"></i> School Profiles
                </div>

                <div class="nav-item" onclick="proExamApp.nav('students', this)">
                    <i class="ph-bold ph-student"></i> Search Results
                </div>




                <div class="nav-item nav-logout" onclick="proExamApp.logout()">
                    <i class="ph-bold ph-sign-out"></i> Logout
                </div>
            </nav>
        </aside>

        <!-- MAIN PANEL CONTAINER -->
        <main id="panelContainer">

            <!-- 1. DASHBOARD PANEL -->
            <section id="panel-dashboard" class="panel active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="stat-total">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="stat-pass" style="color: var(--success);">0%</div>
                        <div class="stat-label">Pass Percentage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="stat-top">0</div>
                        <div class="stat-label">Top Score</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>System Status</h3>
                    <p style="color: var(--text-muted);">
                        Memory-Only Session Active.
                        <br>Please configure settings and upload results to begin.
                    </p>
                    <button class="btn btn-primary"
                        onclick="proExamApp.nav('upload', document.querySelectorAll('.nav-item')[1])">
                        Start Upload
                    </button>
                </div>

                <div class="card" style="border-color: var(--primary);">
                    <h3>Static Site Publishing</h3>
                    <p style="color: var(--text-muted);">
                        Generate a combined data file to update the public portal.
                    </p>
                    <button class="btn btn-primary" onclick="proExamApp.publishData()">
                        <i class="ph-bold ph-paper-plane-tilt"></i> Publish & Download JSON
                    </button>
                </div>
            </section>

            <!-- 2. UPLOAD RESULTS PANEL -->
            <section id="panel-upload" class="panel">
                <h2>Upload Results Data</h2>
                <div class="card">
                    <div class="form-group">
                        <label>Select `published-results.json` File</label>
                        <input type="file" accept=".json" class="form-control"
                            onchange="proExamApp.handleJsonUpload(this)">
                    </div>
                    <div id="upload-status" style="margin-top: 10px; color: var(--text-muted);">Waiting for file...
                    </div>
                </div>

                <h3>Data Preview</h3>
                <div class="card">
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Name</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="preview-tbody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--text-muted);">No Data
                                        Loaded
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 3. CERTIFICATE CONFIG PANEL -->
            <section id="panel-certificate" class="panel">
                <h2>Certificate Configuration</h2>
                <div class="card" style="max-width: 600px;">
                    <div class="form-group">
                        <label>Institution Name</label>
                        <input type="text" id="conf-school" class="form-control" value="Global Excellence Academy">
                    </div>
                    <div class="form-group">
                        <label>Certificate Title</label>
                        <input type="text" id="conf-title" class="form-control" value="Official Statement of Marks">
                    </div>
                    <div class="form-group">
                        <label>Academic Session</label>
                        <input type="text" id="conf-session" class="form-control" value="2025-2026">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <select id="conf-lang" class="form-control">
                            <option value="en">English</option>
                            <option value="mal">Malayalam</option>
                            <option value="ar">Arabic</option>
                            <option value="urd">Urdu</option>
                            <option value="hin">Hindi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pass Mark Value</label>
                        <input type="number" id="conf-passEval" class="form-control" value="35">
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="proExamApp.saveConfig()">Save
                            Configuration</button>
                    </div>
                </div>
            </section>

            <!-- 4. SIGNATURE PANEL -->
            <section id="panel-signature" class="panel">
                <h2>Principal Signature</h2>
                <div class="card" style="max-width: 500px;">
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                        Upload signature image (PNG/JPG). It will be automatically compressed to &lt;100KB for
                        performance.
                    </p>

                    <div class="form-group">
                        <input type="file" accept="image/*" class="form-control"
                            onchange="proExamApp.handleSignature(this)">
                    </div>

                    <div
                        style="margin-top: 20px; text-align: center; border: 1px dashed var(--border); padding: 20px; border-radius: 8px;">
                        <img id="sig-preview" src="" style="max-height: 100px; max-width: 100%; display: none;">
                        <p id="sig-status" style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted);">No
                            signature uploaded</p>
                    </div>
                </div>
            </section>

            <!-- 5. ANALYTICS PANEL -->
            <section id="panel-analytics" class="panel">
                <h2>Detailed Analytics</h2>
                <div class="card">
                    <p>Analytics view becomes available after uploading results.</p>
                    <!-- Placeholder for future charts/graphs -->
                    <div id="analytics-content" style="padding: 40px; text-align: center; color: var(--text-muted);">
                        Waiting for data...
                    </div>
                </div>
            </section>

            <!-- 6. SCHOOL PROFILES PANEL -->
            <section id="panel-schools" class="panel">
                <h2>School Profiles</h2>
                <div class="card">
                    <p>Manage multiple school identities here.</p>
                    <div style="margin-top: 20px;">
                        <label>Add New School</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-school-name" class="form-control" placeholder="School Name">
                            <button class="btn btn-primary" onclick="proExamApp.addSchool()">Add</button>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>Active Schools List</h4>
                        <ul id="school-list" style="list-style: none; padding: 0;">
                            <!-- JS populated -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- 7. SEARCH RESULTS PANEL -->
            <section id="panel-students" class="panel">
                <h2>Search Student Results</h2>
                <div class="card">
                    <div class="form-group">
                        <label>Search by Name or Roll Number</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="adminSearchInput" class="form-control"
                                placeholder="Enter keywords..."
                                onkeyup="if(event.key === 'Enter') proExamApp.adminSearch()">
                            <button class="btn btn-primary" onclick="proExamApp.adminSearch()">
                                <i class="ph-bold ph-magnifying-glass"></i> Search
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Name</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-search-tbody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--text-muted);">Perform a
                                        search to see results</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>

    </div><!-- End Admin View -->

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * ------------------------------------------------------------------
         * proExamApp Namespace
         * Encapsulates all logic for the Pro Exam Admin Panel.
         * Memory-only storage (resets on refresh).
         * ------------------------------------------------------------------
         */
        const proExamApp = {

            // --- STATE ---
            state: {
                students: [],
                schools: [
                    { id: 'def', name: 'Default School' },
                    { id: 's2', name: 'Secondary Campus' }
                ],
                activeSchoolId: 'def',
                config: {
                    institution: "",
                    title: "",
                    passMark: 35,
                    lang: "en"
                },
                signature: null // base64 string
            },

            // --- INIT ---
            init() {
                console.log("Pro Exam App Initialized");
                this.renderSchoolSelector();
                this.renderSchoolList();

                // Determine initial view from storage
                const mode = localStorage.getItem('pro_exam_mode') || 'public';
                this.toggleView(mode);
            },

            toggleView(mode) {
                const adminView = document.getElementById('admin-view');
                const publicView = document.getElementById('public-view');
                if (mode === 'public') {
                    if (adminView) adminView.style.display = 'none';
                    if (publicView) publicView.style.display = 'block';
                    localStorage.setItem('pro_exam_mode', 'public');
                } else {
                    if (adminView) adminView.style.display = 'flex';
                    if (publicView) publicView.style.display = 'none';
                    localStorage.setItem('pro_exam_mode', 'admin');

                    // Default to dashboard panel when switching to admin
                    this.nav('dashboard', document.querySelector('.nav-item'));
                }
            },

            // --- NAVIGATION ---
            nav(panelId, el) {
                // 1. Hide all panels
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

                // 2. Show target panel
                const target = document.getElementById('panel-' + panelId);
                if (target) target.classList.add('active');

                // 3. Update Sidebar Active State
                if (el) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }

                // Mobile: Close sidebar after click
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('proExamSidebar');
                    if (sidebar) sidebar.classList.remove('open');
                }
            },

            // --- SEARCH LOGIC ---
            adminSearch() {
                const query = document.getElementById('adminSearchInput').value.trim().toLowerCase();
                const tbody = document.getElementById('admin-search-tbody');

                if (!query) return;

                const filtered = this.state.students.filter(s =>
                    (s.name && s.name.toLowerCase().includes(query)) ||
                    (s.roll && s.roll.toString().includes(query)) ||
                    (s.registerNumber && s.registerNumber.toString().includes(query))
                );

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No students found</td></tr>';
                    return;
                }

                tbody.innerHTML = filtered.map(s => `
                    <tr>
                        <td>${s.roll || s.registerNumber || '-'}</td>
                        <td>${s.name}</td>
                        <td>${s.total || 0}</td>
                        <td>
                            <button class="btn btn-mini btn-secondary" onclick="proExamApp.viewStudentDetails('${s.roll || s.registerNumber}')">
                                <i class="ph ph-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');
            },

            publicSearch() {
                const reg = document.getElementById('publicRegInput').value.trim();
                const msg = document.getElementById('public-msg');

                if (!reg) {
                    msg.textContent = "Please enter a register number";
                    return;
                }

                const student = this.state.students.find(s =>
                    (s.roll && s.roll.toString() === reg) ||
                    (s.registerNumber && s.registerNumber.toString() === reg)
                );

                if (student) {
                    msg.textContent = "";
                    alert(`Result Found: ${student.name} - Total: ${student.total}`);
                    // Here you would normally show a result modal or redirect
                } else {
                    msg.textContent = "No result found for this register number";
                }
            },

            // View Student details (Admin Result View)
            viewStudentDetails(roll) {
                const student = this.state.students.find(s => (s.roll || s.registerNumber).toString() === roll);
                if (student) {
                    alert(`Student: ${student.name}\nRoll: ${student.roll || student.registerNumber}\nTotal: ${student.total}`);
                }
            },

            logout() {
                if (confirm("Logout? All unsaved memory data will be lost.")) {
                    window.location.href = '../dashboard.html'; // Fallback or logic
                }
            },

            // --- SCHOOL LOGIC ---
            renderSchoolSelector() {
                const sel = document.getElementById('active-school-selector');
                sel.innerHTML = this.state.schools.map(s =>
                    `<option value="${s.id}" ${s.id === this.state.activeSchoolId ? 'selected' : ''}>${s.name}</option>`
                ).join('');
            },

            renderSchoolList() {
                const ul = document.getElementById('school-list');
                ul.innerHTML = this.state.schools.map(s => `
                    <li style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                        <span>${s.name}</span>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">ID: ${s.id}</span>
                    </li>
                `).join('');
            },

            switchSchool(schoolId) {
                this.state.activeSchoolId = schoolId;
                console.log("Switched to School ID:", schoolId);
                // In a real app, you might filter students by schoolId here
                alert(`Switched context to: ${this.state.schools.find(s => s.id === schoolId).name}`);
            },

            addSchool() {
                const name = document.getElementById('new-school-name').value.trim();
                if (!name) return;

                const newId = 's-' + Date.now();
                this.state.schools.push({ id: newId, name: name });

                document.getElementById('new-school-name').value = '';
                this.renderSchoolSelector();
                this.renderSchoolList();
            },

            // --- RESULTS UPLOAD ---
            handleJsonUpload(input) {
                const file = input.files[0];
                const statusEl = document.getElementById('upload-status');

                if (!file) return;
                statusEl.textContent = "Processing...";

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        let data = [];

                        // --- V2.0 Recovery Logic ---
                        if (json.version === "2.0") {
                            console.log("Loading V2.0 Workspace...");
                            if (json.meta) {
                                this.state.config = json.meta;
                                // Update Form Fields
                                document.getElementById('conf-school').value = json.meta.institution || "";
                                document.getElementById('conf-title').value = json.meta.title || "";
                                document.getElementById('conf-session').value = json.meta.session || "";
                                document.getElementById('conf-lang').value = json.meta.lang || "en";
                                document.getElementById('conf-passEval').value = json.meta.passMark || 35;
                            }
                            if (json.signature) {
                                this.state.signature = json.signature;
                                document.getElementById('sig-preview').src = json.signature;
                                document.getElementById('sig-preview').style.display = 'block';
                                document.getElementById('sig-status').textContent = "Signature recovered from file.";
                            }
                            if (json.data && json.data.exams) {
                                json.data.exams.forEach(ex => data.push(...ex.results));
                            }
                        }
                        // --- Legacy/Generic Formats ---
                        else if (Array.isArray(json)) data = json;
                        else if (json.exams) {
                            json.exams.forEach(ex => {
                                if (ex.results) data.push(...ex.results);
                            });
                        }
                        else if (json.data && Array.isArray(json.data)) data = json.data;

                        this.state.students = data;
                        statusEl.innerHTML = `<span style="color: var(--success);">✅ Successfully loaded ${data.length} records.</span>`;
                        statusEl.style.color = "var(--success)";

                        this.updateStats();
                        this.renderPreview();

                    } catch (err) {
                        console.error(err);
                        statusEl.textContent = "❌ Error: Invalid JSON Format";
                        statusEl.style.color = "var(--danger)";
                    }
                };
                reader.readAsText(file);
            },

            renderPreview() {
                const tbody = document.getElementById('preview-tbody');
                const list = this.state.students.slice(0, 10); // Show first 10

                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No Data</td></tr>';
                    return;
                }

                tbody.innerHTML = list.map(s => `
                    <tr>
                        <td>${s.roll || s.registerNumber || '-'}</td>
                        <td>${s.name}</td>
                        <td>${s.total || 0}</td>
                        <td><span style="color: var(--success); font-size: 0.8rem; border: 1px solid var(--success); padding: 2px 6px; border-radius: 4px;">Ready</span></td>
                    </tr>
                `).join('');
            },

            updateStats() {
                const total = this.state.students.length;
                document.getElementById('stat-total').textContent = total;

                // Simple Pass Calculation (Example logic)
                let passed = 0;
                let topScore = 0;
                const passMark = this.state.config.passMark || 35;

                this.state.students.forEach(s => {
                    const score = Number(s.total) || 0;
                    if (score > topScore) topScore = score;

                    // Assume pass if total > (subjects * 35)? Or check detail? 
                    // Simplifying for analytics overview:
                    if (score >= (Object.keys(s.subjects || {}).length * passMark)) passed++;
                });

                const perc = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

                document.getElementById('stat-pass').textContent = perc + "%";
                document.getElementById('stat-top').textContent = topScore;

                // Update analytics text
                document.getElementById('analytics-content').innerHTML = `
                    <div class="stats-grid">
                         <div class="stat-card">
                            <div class="stat-val">${total}</div>
                            <div class="stat-label">Total</div>
                         </div>
                         <div class="stat-card">
                            <div class="stat-val" style="color:var(--success)">${passed}</div>
                            <div class="stat-label">Passed</div>
                         </div>
                         <div class="stat-card">
                            <div class="stat-val" style="color:var(--danger)">${total - passed}</div>
                            <div class="stat-label">Failed</div>
                         </div>
                    </div>
                `;
            },

            // --- CONFIGURATION ---
            saveConfig() {
                this.state.config.institution = document.getElementById('conf-school').value;
                this.state.config.title = document.getElementById('conf-title').value;
                this.state.config.institution = document.getElementById('conf-school').value;
                this.state.config.passMark = Number(document.getElementById('conf-passEval').value);
                this.state.config.lang = document.getElementById('conf-lang').value;

                alert("Configuration saved to memory!");
            },

            // --- PUBLISHING ---
            publishData() {
                if (this.state.students.length === 0) {
                    return alert("No student data to publish! Please upload results first.");
                }

                // Combine everything into a single storage object
                const publishPayload = {
                    version: "2.0",
                    timestamp: new Date().toISOString(),
                    meta: this.state.config,
                    signature: this.state.signature,
                    data: {
                        exams: [
                            {
                                id: "published_" + Date.now(),
                                name: this.state.config.title || "Published Results",
                                results: this.state.students
                            }
                        ]
                    }
                };

                const blob = new Blob([JSON.stringify(publishPayload, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "published-results.json";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert("Success! Download the 'published-results.json' file and upload it to your 'data/' folder on GitHub Pages.");
            },

            // --- SIGNATURE HANDLER (Compression) ---
            handleSignature(input) {
                const file = input.files[0];
                if (!file) return;

                const statusEl = document.getElementById('sig-status');
                const previewEl = document.getElementById('sig-preview');

                statusEl.textContent = "Compressing...";

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;

                    img.onload = () => {
                        // Create Canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Calculate Aspect Ratio
                        let width = img.width;
                        let height = img.height;
                        const MAX_WIDTH = 300; // Resize if wider than 300px

                        if (width > MAX_WIDTH) {
                            height = Math.round(height * (MAX_WIDTH / width));
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Draw
                        ctx.drawImage(img, 0, 0, width, height);

                        // Compress: standard JPEG quality 0.7
                        // This usually results in very small sizes for signatures
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        this.state.signature = compressedDataUrl;

                        // Display
                        previewEl.src = compressedDataUrl;
                        previewEl.style.display = 'block';

                        // Calculate size estimation
                        const sizeInBytes = Math.ceil((compressedDataUrl.length - 'data:image/jpeg;base64,'.length) * 3 / 4);
                        const kb = (sizeInBytes / 1024).toFixed(1);

                        statusEl.innerHTML = `<span style="color:var(--success)">✅ Optimized: ${kb} KB (Ready)</span>`;
                    };
                };
                reader.readAsDataURL(file);
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            proExamApp.init();
        });

    </script>
</body>

</html>