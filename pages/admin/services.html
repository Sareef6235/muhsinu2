<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services Manager | Admin Dashboard</title>
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <script src="../../assets/js/utils/performance.js" defer></script>
    <script src="../../assets/js/site-languages.js" defer></script>
    <link rel="stylesheet" href="../../assets/css/modern-nav.css">
    <link rel="stylesheet" href="../../assets/css/site-footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --admin-bg: #0a0a0a;
            --panel-bg: rgba(20, 20, 20, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #00f3ff;
        }

        body {
            background: var(--admin-bg);
            color: #fff;
            font-family: 'Outfit', sans-serif;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            height: calc(100vh - 80px);
            margin-top: 80px;
            overflow: hidden;
        }

        /* Sidebar: Services List */
        .sidebar {
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .services-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .service-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: move;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .service-item:hover {
            border-color: var(--accent-color);
            background: rgba(0, 243, 255, 0.05);
        }

        .service-item.active {
            border-color: var(--accent-color);
            background: rgba(0, 243, 255, 0.1);
        }

        .service-item i {
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .service-info {
            flex: 1;
        }

        .service-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .service-info p {
            margin: 5px 0 0;
            font-size: 0.8rem;
            color: #888;
        }

        /* Main Editor */
        .main-editor {
            padding: 40px;
            overflow-y: auto;
            background: #000;
        }

        .editor-section {
            margin-bottom: 40px;
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .editor-section h3 {
            margin-top: 0;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #aaa;
        }

        input,
        textarea,
        select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: #000;
            font-weight: 600;
        }

        /* Feature List Editor */
        .feature-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .remove-btn {
            background: rgba(255, 50, 50, 0.2);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff5555;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Preview Panel */
        .preview-panel {
            background: #111;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #live-preview {
            flex: 1;
            border: none;
            background: #fff;
            border-radius: 10px;
            margin: 20px;
            overflow: hidden;
        }

        /* Icon Picker Button */
        .icon-picker-trigger {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
        }

        .icon-picker-trigger i {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: #000;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-color);
            color: #fff;
        }

        .btn-danger {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff5555;
        }

        /* Media Upload */
        .media-preview {
            margin-top: 15px;
            height: 150px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            border: 1px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: 0.3s;
        }

        .media-preview:hover .upload-overlay {
            opacity: 1;
        }

        /* Floating Actions */
        .floating-actions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            border: 1px solid var(--accent-color);
        }
    </style>
</head>

<body>
    <header id="main-header"></header>
    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Services</h2>
                <button class="btn btn-primary" onclick="createNewService()"><i class="ph ph-plus"></i></button>
            </div>
            <div class="services-list" id="services-sortable">
                <!-- Items injected via JS -->
            </div>
            <div style="padding: 20px;">
                <button class="btn btn-ghost" style="width: 100%;" onclick="exportData()"><i class="ph ph-download"></i>
                    Export JSON</button>
            </div>
        </aside>

        <!-- EDITOR -->
        <main class="main-editor">
            <div id="editor-container" style="display: none;">
                <div class="editor-section">
                    <h3><i class="ph ph-sliders"></i> General Settings</h3>
                    <div class="form-group">
                        <label>Service ID (Unique Slug)</label>
                        <input type="text" id="svc-id" readonly>
                    </div>
                    <div class="form-group">
                        <label>Layout Template</label>
                        <select id="svc-template"></select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 15px;">
                        <input type="checkbox" id="svc-visible" style="width: auto;">
                        <label style="margin: 0;">Visible on Website</label>
                    </div>
                </div>

                <div class="editor-section">
                    <h3><i class="ph ph-pencil-line"></i> Content (Multi-language)</h3>
                    <div class="tabs">
                        <button class="tab-btn active" data-lang="en">English</button>
                        <button class="tab-btn" data-lang="ml">Malayalam</button>
                        <button class="tab-btn" data-lang="ar">Arabic</button>
                    </div>
                    <div class="lang-panes">
                        <div class="form-group">
                            <label>Service Title</label>
                            <input type="text" id="svc-title">
                        </div>
                        <div class="form-group">
                            <label>Short Description</label>
                            <textarea id="svc-short-desc" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Full Description (Markdown/HTML)</label>
                            <textarea id="svc-full-desc" rows="5"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Feature Points</label>
                            <div id="features-editor"></div>
                            <button class="btn btn-ghost" style="margin-top: 10px;" onclick="addFeature()"><i
                                    class="ph ph-plus"></i> Add Point</button>
                        </div>
                    </div>
                </div>

                <div class="editor-section">
                    <h3><i class="ph ph-image"></i> Media & Visuals</h3>
                    <div class="form-group">
                        <label>Icon</label>
                        <div class="icon-picker-trigger" onclick="openIconPicker()">
                            <i id="svc-icon-preview" class="ph ph-question"></i>
                            <span id="svc-icon-name">ph ph-question</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Featured Image (Auto-WebP)</label>
                            <div class="media-preview" id="img-preview-box">
                                <div class="upload-overlay"><i class="ph ph-upload-simple"></i></div>
                                <input type="file" id="img-upload" hidden accept="image/*">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Video Background (Max 5MB)</label>
                            <div class="media-preview" id="vid-preview-box">
                                <div class="upload-overlay"><i class="ph ph-upload-simple"></i></div>
                                <input type="file" id="vid-upload" hidden accept="video/*">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="no-selection" style="text-align: center; padding: 100px 0; color: #555;">
                <i class="ph ph-mouse-left-click" style="font-size: 5rem; margin-bottom: 20px;"></i>
                <p>Select a service to edit or create a new one.</p>
            </div>
        </main>

        <!-- PREVIEW -->
        <aside class="preview-panel">
            <div class="preview-header">
                <h3>Live Preview</h3>
                <div class="preview-controls">
                    <i class="ph ph-device-mobile"></i>
                    <i class="ph ph-device-tablet"></i>
                    <i class="ph ph-monitor active"></i>
                </div>
            </div>
            <iframe id="live-preview"></iframe>
        </aside>
    </div>

    <!-- FLOATING ACTIONS -->
    <div class="floating-actions" id="save-actions" style="display: none;">
        <button class="btn btn-ghost" onclick="resetChanges()">Discard</button>
        <button class="btn btn-danger" onclick="deleteService()"><i class="ph ph-trash"></i> Delete</button>
        <button class="btn btn-primary" onclick="saveChanges()"><i class="ph ph-check"></i> Save Changes</button>
    </div>

    <script type="module">
        import { ServicesCMS } from '../../assets/js/services-cms.js';
        import { MediaOptimizer } from '../../assets/js/media-optimizer.js';

        let currentServiceId = null;
        let activeLang = 'en';
        let originalService = null;
        let modifiedService = null;

        // --- Initialization ---
        window.onload = async () => {
            await loadServicesList();
            await initTemplates();
            initTabs();
            initUploaders();
        };

        async function initTemplates() {
            const select = document.getElementById('svc-template');
            (await ServicesCMS.getTemplates()).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                select.appendChild(opt);
            });
            select.onchange = () => {
                modifiedService.templateId = select.value;
                updatePreview();
            };
        }

        async function loadServicesList() {
            const list = document.getElementById('services-sortable');
            list.innerHTML = '';
            const services = await ServicesCMS.getAll();
            services.forEach(s => {
                const el = document.createElement('div');
                el.className = `service-item ${currentServiceId === s.id ? 'active' : ''}`;
                el.dataset.id = s.id;
                el.innerHTML = `
                    <i class="${s.icon}"></i>
                    <div class="service-info">
                        <h4>${s.content.en.title || 'Untitled'}</h4>
                        <p>${s.templateId} â€¢ ${s.visible ? 'Visible' : 'Hidden'}</p>
                    </div>
                `;
                el.onclick = () => selectService(s.id);
                list.appendChild(el);
            });

            // Init Drag & Drop
            new Sortable(list, {
                animation: 150,
                onEnd: async (evt) => {
                    await ServicesCMS.reorder(evt.item.dataset.id, evt.newIndex);
                    updatePreview();
                }
            });
        }

        async function selectService(id) {
            currentServiceId = id;
            originalService = await ServicesCMS.getById(id);
            modifiedService = JSON.parse(JSON.stringify(originalService)); // Deep clone

            document.getElementById('editor-container').style.display = 'block';
            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('save-actions').style.display = 'flex';

            fillEditorFields();
            loadServicesList();
            updatePreview();
        }

        function fillEditorFields() {
            document.getElementById('svc-id').value = modifiedService.id;
            document.getElementById('svc-template').value = modifiedService.templateId;
            document.getElementById('svc-visible').checked = modifiedService.visible;
            document.getElementById('svc-icon-preview').className = modifiedService.icon;
            document.getElementById('svc-icon-name').textContent = modifiedService.icon;

            const c = modifiedService.content[activeLang];
            document.getElementById('svc-title').value = c.title || '';
            document.getElementById('svc-short-desc').value = c.shortDesc || '';
            document.getElementById('svc-full-desc').value = c.fullDesc || '';

            renderFeaturesList(c.features);
            renderMediaPreviews();
        }

        function renderFeaturesList(features) {
            const container = document.getElementById('features-editor');
            container.innerHTML = '';
            features.forEach((f, i) => {
                const row = document.createElement('div');
                row.className = 'feature-item';
                row.innerHTML = `
                    <input type="text" value="${f}" oninput="updateFeature(${i}, this.value)">
                    <button class="remove-btn" onclick="removeFeature(${i})"><i class="ph ph-x"></i></button>
                `;
                container.appendChild(row);
            });
        }

        function renderMediaPreviews() {
            const imgBox = document.getElementById('img-preview-box');
            const vidBox = document.getElementById('vid-preview-box');

            imgBox.style.backgroundImage = modifiedService.image ? `url(${modifiedService.image})` : 'none';
            imgBox.innerHTML = modifiedService.image ? '<div class="upload-overlay"><i class="ph ph-upload-simple"></i></div>' : '<span>No Image</span>';

            vidBox.innerHTML = modifiedService.video ?
                `<video src="${modifiedService.video}" autoplay muted loop></video><div class="upload-overlay"><i class="ph ph-upload-simple"></i></div>` :
                '<span>No Video</span>';
        }

        // --- CMS Logic Overrides (Global for helper access) ---
        window.updateFeature = (idx, val) => {
            modifiedService.content[activeLang].features[idx] = val;
            updatePreview();
        };
        window.removeFeature = (idx) => {
            modifiedService.content[activeLang].features.splice(idx, 1);
            renderFeaturesList(modifiedService.content[activeLang].features);
            updatePreview();
        };
        window.addFeature = () => {
            modifiedService.content[activeLang].features.push('New Point');
            renderFeaturesList(modifiedService.content[activeLang].features);
            updatePreview();
        };

        // --- Language Handling ---
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    // Sync current fields back to object before switching
                    syncFields();

                    document.querySelector('.tab-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    activeLang = btn.dataset.lang;
                    fillEditorFields();
                    updatePreview();
                };
            });
        }

        function syncFields() {
            if (!modifiedService) return;
            const c = modifiedService.content[activeLang];
            c.title = document.getElementById('svc-title').value;
            c.shortDesc = document.getElementById('svc-short-desc').value;
            c.fullDesc = document.getElementById('svc-full-desc').value;
            modifiedService.visible = document.getElementById('svc-visible').checked;
        }

        // --- Media Handling ---
        function initUploaders() {
            const imgInput = document.getElementById('img-upload');
            const vidInput = document.getElementById('vid-upload');

            document.getElementById('img-preview-box').onclick = () => imgInput.click();
            document.getElementById('vid-preview-box').onclick = () => vidInput.click();

            imgInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const optimized = await MediaOptimizer.processImage(file);
                    modifiedService.image = optimized;
                    renderMediaPreviews();
                    updatePreview();
                } catch (err) { alert(err); }
            };

            vidInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    await MediaOptimizer.validateVideo(file);
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        modifiedService.video = ev.target.result;
                        renderMediaPreviews();
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                } catch (err) { alert(err); }
            };
        }

        // --- Preview Mode ---
        function updatePreview() {
            syncFields();
            const iframe = document.getElementById('live-preview');
            const previewDoc = `
                <html>
                <head>
                    <link rel="stylesheet" href="../../assets/css/styles.css">
                </head>
                <body style="background:#000; margin:0; padding:0;">
                    <div id="render-target"></div>
                    <script type="module">
                        import { ServiceRenderer } from '../../assets/js/service-renderer.js';
                        const service = ${JSON.stringify(modifiedService)};
                        const lang = '${activeLang}';
                        document.getElementById('render-target').innerHTML = ServiceRenderer.render(service, lang);
                    <\/script>
</body>

</html>
`;
            iframe.srcdoc = previewDoc;
        }

        // --- Global Actions ---
        window.createNewService = async () => {
            const id = prompt("Enter a unique URL slug (e.g., madrasa-education):");
            if (!id) return;
            if (await ServicesCMS.getById(id)) return alert("ID already exists!");

            const newSvc = {
                id,
                visible: true,
                templateId: 'corporate',
                icon: 'ph ph-app-window',
                image: null,
                video: null,
                content: {
                    en: { title: 'New Service', shortDesc: '', fullDesc: '', features: [] },
                    ml: { title: '', shortDesc: '', fullDesc: '', features: [] },
                    ar: { title: '', shortDesc: '', fullDesc: '', features: [] }
                },
                createdAt: new Date().toISOString()
            };

            await ServicesCMS.add(newSvc);
            await selectService(id);
        };

        window.saveChanges = async () => {
            syncFields();
            await ServicesCMS.update(currentServiceId, modifiedService);
            originalService = JSON.parse(JSON.stringify(modifiedService));
            await loadServicesList();
            alert("Changes saved to Database!");
        };

        window.resetChanges = async () => {
            if (confirm("Discard all unsaved changes?")) {
                await selectService(currentServiceId);
            }
        };

        window.deleteService = async () => {
            if (confirm("Delete this service permanently?")) {
                await ServicesCMS.delete(currentServiceId);
                currentServiceId = null;
                document.getElementById('editor-container').style.display = 'none';
                document.getElementById('no-selection').style.display = 'block';
                document.getElementById('save-actions').style.display = 'none';
                await loadServicesList();
            }
        };

        window.exportData = () => {
            ServicesCMS.exportData();
        };

        window.openIconPicker = () => {
            const icon = prompt("Enter Phosphor Icon class (e.g., ph ph-heart-break):", modifiedService.icon);
            if (icon) {
                modifiedService.icon = icon;
                fillEditorFields();
                updatePreview();
            }
        };

    </script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="../../assets/js/site-nav.js" defer></script>
    <script type="module" src="../../assets/js/admin-auth.js"></script>
</body>

</html>