<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exams Results | MIFTHAHUL HUDA</title>

    <!-- Unified Assets -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        .portal-wrapper {
            max-width: 800px;
            margin: 120px auto 100px;
            padding: 0 20px;
        }

        .marks-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .marks-table th {
            text-align: left;
            padding: 12px;
            color: #666;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
        }

        .marks-table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 1.1rem;
        }

        .btn-check {
            width: 100%;
            padding: 18px;
            background: var(--primary-color);
            color: #000;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-sec {
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>

    <script type="module">
        import AppState from '../../assets/js/state.js';
        import NavigationSystem from '../../assets/js/navigation.js';
        import FooterSystem from '../../assets/js/footer.js';
        import ResultsPortal from '../../assets/js/portal.js';

        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            NavigationSystem.init(AppState.navigation.menuData);
            FooterSystem.init();
            ResultsPortal.init();

            // Bind detailed search
            const form = document.getElementById('resultsForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const examId = document.getElementById('examSelect').value;
                    const rollNo = document.getElementById('rollInput').value;
                    const result = await ResultsPortal.searchResult(examId, rollNo);
                    renderSearchResult(result);
                });
            }

            // Bind Merit List
            const meritBtn = document.getElementById('view-merit-btn');
            if (meritBtn) {
                meritBtn.addEventListener('click', () => {
                    const examId = document.getElementById('examSelect').value;
                    if (!examId) return alert("Please select an exam first.");
                    showMeritList(examId);
                });
            }
        });

        function renderSearchResult(result) {
            const display = document.getElementById('result-display');
            if (!result.success) {
                display.innerHTML = `<div class="glass-card" style="text-align:center; padding: 40px; color: #ff4444;">${result.message}</div>`;
            } else {
                const s = result.data;
                display.innerHTML = `
                    <div class="glass-card animate-fade-up" style="margin-top: 30px;">
                        <h2 style="color: var(--primary-color);">${s.name}</h2>
                        <p style="color: #666;">Roll: ${s.roll} | ${result.examName}</p>
                        <div style="font-size: 4rem; font-weight: 800; margin: 30px 0; text-align: center;">${s.total}</div>
                        <button class="btn-sec" style="width: 100%;" onclick="window.print()"><i class="ph ph-printer"></i> PRINT MARK SHEET</button>
                    </div>
                `;
            }
            display.style.display = "block";
        }

        function showMeritList(examId) {
            // Logic to be refined in portal.js or here
            const meritView = document.getElementById('merit-view');
            const searchSection = document.getElementById('search-section');
            const exam = ResultsPortal.data.exams.find(e => (e.examId || e.id) === examId);

            if (!exam) return;

            searchSection.style.display = "none";
            meritView.style.display = "block";
            document.getElementById('merit-exam-name').textContent = exam.examName || exam.name;

            const sorted = [...exam.results].sort((a, b) => b.total - a.total);
            const body = document.getElementById('results-table-body');
            body.innerHTML = sorted.map((r, i) => `
                <tr>
                    <td>#${i + 1}</td>
                    <td>${r.roll}</td>
                    <td>${r.name}</td>
                    <td style="text-align: right; color: var(--primary-color); font-weight: 800;">${r.total}</td>
                </tr>
            `).join('');
        }

        window.showSearchForm = () => {
            document.getElementById('merit-view').style.display = "none";
            document.getElementById('search-section').style.display = "block";
        };
    </script>
</head>

<body>
    <header id="site-header"></header>
    <div id="site-breadcrumbs"></div>

    <div class="portal-wrapper">
        <div id="search-section" class="glass-card">
            <div class="portal-title" style="text-align: center; margin-bottom: 40px;">
                <h1>Detailed Results Portal</h1>
                <p style="color: #666;">Academic performance tracking and verification</p>
            </div>

            <form id="resultsForm">
                <div style="margin-bottom: 20px;">
                    <label style="color: #888; display: block; margin-bottom: 5px;">Exam Session</label>
                    <select id="examSelect" data-exam-source="published" required></select>
                </div>
                <div style="margin-bottom: 30px;">
                    <label style="color: #888; display: block; margin-bottom: 5px;">Roll Number</label>
                    <input type="text" id="rollInput" placeholder="Enter Registration No." required>
                </div>
                <button type="submit" class="btn-check">
                    <span>Check Performance</span>
                    <i class="ph ph-arrow-right"></i>
                </button>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" id="view-merit-btn" class="btn-sec" style="flex: 1;">
                        <i class="ph ph-medal"></i> View Merit List
                    </button>
                    <label for="manual-upload" class="btn-sec" style="flex: 1; cursor: pointer;">
                        <i class="ph ph-upload"></i> Upload JSON
                    </label>
                    <input type="file" id="manual-upload" style="display: none;">
                </div>
            </form>
        </div>

        <div id="merit-view" class="glass-card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>üèÜ Merit List: <span id="merit-exam-name" style="font-weight: 400; opacity: 0.7;"></span></h2>
                <button class="btn-sec" onclick="showSearchForm()">Back</button>
            </div>
            <table class="marks-table">
                <thead>
                    <tr>
                        <th>RANK</th>
                        <th>ROLL</th>
                        <th>NAME</th>
                        <th style="text-align: right;">TOTAL</th>
                    </tr>
                </thead>
                <tbody id="results-table-body"></tbody>
            </table>
        </div>

        <div id="result-display" style="display: none;"></div>
    </div>

    <footer id="site-footer"></footer>
</body>

</html>