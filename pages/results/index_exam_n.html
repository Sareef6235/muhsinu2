<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result Portal | Official Statement of Marks</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Noto+Sans+Kannada:wght@400;700&family=Noto+Sans+Telugu:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #1a237e;
            --secondary: #c6a700;
            --bg: #f4f6f8;
            --surface: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --success: #27ae60;
            --danger: #c0392b;
            --border: #e0e0e0;
            --sidebar-width: 260px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- UTILS --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0d1250;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            background: #f9f9f9;
        }

        .btn-danger {
            background: #fee;
            color: var(--danger);
            border: 1px solid #fcc;
        }

        .card {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            margin-bottom: 10px;
        }

        /* --- PUBLIC VIEW --- */
        #public-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* --- ADMIN SIDEBAR --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        #sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-logo {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
            transition: 0.2s;
        }

        .nav-item:hover {
            background: #f5f5f5;
            color: var(--primary);
        }

        .nav-item.active {
            background: #e8eaf6;
            color: var(--primary);
            font-weight: 500;
            border-right: 3px solid var(--primary);
        }

        .admin-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            min-height: 100vh;
            transition: margin 0.3s ease;
        }

        .admin-content.full {
            margin-left: 0;
        }

        /* Panels */
        .panel {
            display: none;
            animation: fadeIn 0.3s;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stat-val {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-main);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }


        /* --- CERTIFICATE PREVIEW AREA --- */
        #certificate-area {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
            padding: 40px 0;
        }

        #certificate-area.visible {
            display: flex;
            justify-content: center;
        }

        /* A4 Cert Design */
        .cert-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            position: relative;
            padding: 15mm;
            margin: auto;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .cert-border {
            border: 2px solid var(--primary);
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 10mm;
        }

        .corner-ornament {
            position: absolute;
            width: 30mm;
            height: 30mm;
        }

        .co-tl {
            top: -2px;
            left: -2px;
            border-top: 4px solid var(--primary);
            border-left: 4px solid var(--primary);
        }

        .co-tr {
            top: -2px;
            right: -2px;
            border-top: 4px solid var(--primary);
            border-right: 4px solid var(--primary);
        }

        .co-bl {
            bottom: -2px;
            left: -2px;
            border-bottom: 4px solid var(--primary);
            border-left: 4px solid var(--primary);
        }

        .co-br {
            bottom: -2px;
            right: -2px;
            border-bottom: 4px solid var(--primary);
            border-right: 4px solid var(--primary);
        }

        .cert-header {
            text-align: center;
            margin-bottom: 10mm;
        }

        .inst-name {
            font-family: 'Cinzel', serif;
            font-size: 24pt;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 2mm;
            text-transform: uppercase;
        }

        .cert-title {
            font-family: 'Playfair Display', serif;
            font-size: 18pt;
            color: var(--secondary);
            font-style: italic;
            margin-bottom: 4mm;
        }

        .session-text {
            font-size: 11pt;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .candidate-box {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10mm;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5mm;
        }

        .candidate-info p {
            font-size: 12pt;
            margin: 2mm 0;
            font-family: 'Playfair Display', serif;
        }

        .candidate-info strong {
            font-family: 'Cinzel', serif;
            color: var(--text-main);
            font-size: 13pt;
        }

        .candidate-photo {
            width: 35mm;
            height: 45mm;
            border: 1px solid #ddd;
            object-fit: cover;
            background: #eee;
        }

        .marks-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10mm;
            font-size: 11pt;
        }

        .marks-table th {
            background: var(--primary);
            color: white;
            padding: 3mm;
            text-transform: uppercase;
            font-size: 9pt;
            border: 1px solid var(--primary);
        }

        .marks-table td {
            border: 1px solid #ddd;
            padding: 3mm;
            text-align: center;
            font-family: 'Roboto', sans-serif;
        }

        .marks-table td:first-child {
            text-align: left;
            padding-left: 5mm;
            font-weight: 500;
        }

        .status-pass {
            color: var(--success);
            font-weight: 700;
        }

        .status-fail {
            color: var(--danger);
            font-weight: 700;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5mm;
            margin-bottom: 15mm;
            background: #f8f9fa;
            padding: 5mm;
            border: 1px solid #eee;
        }

        .sum-item {
            text-align: center;
        }

        .sum-val {
            font-size: 16pt;
            font-family: 'Cinzel', serif;
            color: var(--primary);
            font-weight: 700;
        }

        .cert-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .sign-img {
            max-height: 20mm;
            display: block;
            margin: 0 auto 2mm;
        }

        /* Print Overrides */
        @media print {
            body * {
                visibility: hidden;
            }

            #certificate-area,
            #printable-cert,
            #printable-cert * {
                visibility: visible;
            }

            #certificate-area {
                position: absolute;
                left: 0;
                top: 0;
                background: white;
                padding: 0;
            }

            .cert-container {
                box-shadow: none;
                margin: 0;
            }
        }

        /* ================================
   PUBLIC RESULT LANDING DESIGN
================================ */

        #public-view-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #eef2f7, #f8fafc);
            padding: 20px;
        }

        .login-box {
            width: 100%;
            max-width: 420px;
            text-align: center;
            padding: 40px 30px;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            animation: fadeUp 0.4s ease;
        }

        .login-box h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .login-box p {
            font-size: 0.95rem;
        }

        .login-box .card {
            margin-top: 20px;
            padding: 18px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03);
        }

        .login-box .card strong {
            color: #1a237e;
        }

        .login-box i {
            color: #1a237e;
            opacity: 0.8;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: #ffffff;
            border: 1px solid #ddd;
            color: #333;
        }

        .btn-secondary:hover {
            background: #1a237e;
            color: #fff;
            border-color: #1a237e;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 35, 126, 0.2);
        }

        /* Small button */
        .btn-sm {
            font-size: 0.8rem;
            padding: 6px 14px;
        }

        /* Animation */
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .login-box {
                padding: 30px 20px;
            }
        }
    </style>
</head>

<body>


    <!-- PUBLIC VIEW -->
    <div id="public-view"></div>

<!-- PUBLIC VIEW -->
        <div id="public-view-section">
            <!-- ADMIN VIEW (Hidden by default) -->
            <div id="admin-view-section" style="display:none;"></div>

            <script src="../../assets/js/exam_secure_portal.js"></script>

        <div class="login-box">
            <div style="font-size:3rem;color:#1a237e;margin-bottom:20px;">
                <i class="ph-bold ph-student"></i>
            </div>
            <h2>Result Portal</h2>
            <p style="color:#777;margin-bottom:25px;">
                Enter Register Number to view result
            </p>

            <input type="text" id="publicRegInput" class="form-control" placeholder="Register Number">

            <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:10px;"
                onclick="proExamApp.publicSearch()">
                View Result
            </button>

            <div id="public-msg" style="margin-top:15px;color:var(--danger);"></div>

            <button class="btn btn-secondary btn-sm" style="margin-top:25px;" onclick="proExamApp.showAdminLogin()">
                <i class="ph-bold ph-lock"></i> Admin Login
            </button>

            <!-- Admin Login Box -->
            <div id="admin-login-box" class="hidden" style="margin-top:15px;">
                <input type="password" id="adminPassInput" class="form-control" placeholder="Admin Password">
                <button class="btn btn-primary" style="width:100%;justify-content:center;"
                    onclick="proExamApp.adminLogin()">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- ================= ADMIN LAYOUT ================= -->
    <div id="admin-layout" class="hidden">

        <!-- SIDEBAR -->
        <aside id="proExamSidebar" class="sidebar">

            <div class="sidebar-logo">
                <i class="ph-bold ph-shield-check"></i> PRO EXAM
            </div>

            <!-- School Selector -->
            <div style="padding: 15px;">
                <select id="proExamSchoolSelector" class="form-control" style="font-size: 0.85rem;"
                    onchange="proExamApp.switchSchool(this.value)">
                    <option value="default">Default School</option>
                </select>
            </div>

            <!-- Navigation -->
            <nav>
                <div class="nav-item" onclick="proExamApp.nav('dashboard', this)">
                    <i class="ph-bold ph-squares-four"></i> Dashboard
                </div>
                <div class="nav-item active" onclick="proExamApp.nav('results', this)">
                    <i class="ph-bold ph-upload-simple"></i> Upload Results
                </div>
                <div class="nav-item" onclick="proExamApp.nav('certificate', this)">
                    <i class="ph-bold ph-certificate"></i> Certificate
                </div>
                <div class="nav-item" onclick="proExamApp.nav('signature', this)">
                    <i class="ph-bold ph-signature"></i> Signature
                </div>
                <div class="nav-item" onclick="proExamApp.nav('analytics', this)">
                    <i class="ph-bold ph-chart-pie-slice"></i> Analytics
                </div>
                <div class="nav-item" onclick="proExamApp.nav('schools', this)">
                    <i class="ph-bold ph-buildings"></i> School Profiles
                </div>
                <div class="nav-item" onclick="proExamApp.logout()" style="color: var(--danger); margin-top:auto;">
                    <i class="ph-bold ph-sign-out"></i> Logout
                </div>
            </nav>
        </aside>

        <!-- CONTENT -->
        <main class="admin-content">

            <!-- 1. DASHBOARD -->
            <div id="panel-dashboard" class="panel active">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="d-total">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="d-pass" style="color: var(--success);">0%</div>
                        <div class="stat-label">Pass Percentage</div>
                    </div>
                </div>
            </div>

            <!-- 2. UPLOAD RESULTS -->
            <div id="panel-results" class="panel">
                <h2>Upload Results</h2>
                <div class="card">
                    <p>Select your <code>published-results.json</code> file.</p>
                    <input type="file" accept=".json" class="form-control" onchange="proExamApp.handleJsonUpload(this)">
                    <p id="upload-status" style="margin-top: 10px; font-weight: 500;"></p>
                </div>

                <h3>Recent Data Preview</h3>
                <div style="overflow-x: auto; background: white; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead style="background: #eee; text-align: left;">
                            <tr>
                                <th style="padding: 10px;">Roll</th>
                                <th style="padding: 10px;">Name</th>
                                <th style="padding: 10px;">Total</th>
                                <th style="padding: 10px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table">
                            <tr>
                                <td colspan="4" style="padding: 20px; text-align: center; color: #888;">No Data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. CERTIFICATE SETTINGS -->
            <div id="panel-certificate" class="panel">
                <h2>Certificate Configuration</h2>
                <div class="card">
                    <div class="form-group">
                        <label>Institution Name</label>
                        <input type="text" id="confSchool" class="form-control" value="Global Excellence Academy"
                            oninput="proExamApp.saveMeta()">
                    </div>
                    <div class="form-group">
                        <label>Certificate Title</label>
                        <input type="text" id="confTitle" class="form-control" value="Official Statement of Marks"
                            oninput="proExamApp.saveMeta()">
                    </div>
                    <div class="form-group">
                        <label>Academic Session</label>
                        <input type="text" id="confSession" class="form-control" value="2025-2026"
                            oninput="proExamApp.saveMeta()">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <select id="confLang" class="form-control" onchange="proExamApp.saveMeta()">
                            <option value="en">English</option>
                            <option value="mal">Malayalam</option>
                            <option value="ar">Arabic</option>
                            <option value="ta">Tamil</option>
                            <option value="kn">Kannada</option>
                            <option value="te">Telugu</option>
                            <option value="ur">Urdu</option>
                            <option value="hi">Hindi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pass Mark Value</label>
                        <input type="number" id="confPass" class="form-control" value="35"
                            oninput="proExamApp.saveMeta()">
                    </div>
                </div>
            </div>

            <!-- 4. SIGNATURE -->
            <div id="panel-signature" class="panel">
                <h2>Principal Signature</h2>
                <div class="card">
                    <input type="file" accept="image/*" class="form-control"
                        onchange="proExamApp.handleSignature(this)">
                    <div style="margin-top: 20px;">
                        <p>Current Signature:</p>
                        <img id="sig-preview" src="" alt="No Signature"
                            style="max-height: 80px; border: 1px dashed #ccc; padding: 10px;">
                    </div>
                </div>
            </div>

            <!-- 5. ANALYTICS -->
            <div id="panel-analytics" class="panel">
                <h2>Analytics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="a-topt">0</div>
                        <div class="stat-label">Top Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="a-avg">0</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>
                <!-- Simple grade distribution could go here -->
            </div>

            <!-- 6. SCHOOL PROFILES (Placeholder) -->
            <div id="panel-schools" class="panel">
                <h2>School Profiles</h2>
                <div class="card">
                    <p>School profile management will be available when multi-school JSON data is loaded.</p>
                </div>
            </div>

        </main>
    </div>


    <!-- ================= CERTIFICATE OVERLAY ================= -->
    <div id="certificate-area"></div>


    <div style="position: absolute; top: 10px; right: 20px; z-index: 2001; display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="proExamApp.closeCert()">Close</button>
        <button class="btn btn-primary" onclick="proExamApp.downloadPDF()">Download PDF</button>
    </div>

    <div class="cert-container" id="printable-cert">
        <div class="cert-border">
            <div class="corner-ornament co-tl"></div>
            <div class="corner-ornament co-tr"></div>
            <div class="corner-ornament co-bl"></div>
            <div class="corner-ornament co-br"></div>

            <div class="cert-header">
                <div class="inst-name" id="c-school"></div>
                <div class="cert-title" id="c-title"></div>
                <div class="session-text" id="c-session"></div>
            </div>

            <div class="candidate-box">
                <div class="candidate-info">
                    <p><span class="lbl-name">Name</span>: <strong id="c-name"></strong></p>
                    <p><span class="lbl-roll">Reg No</span>: <strong id="c-roll"></strong></p>
                </div>
                <img id="c-photo" class="candidate-photo" src="">
            </div>

            <table class="marks-table">
                <thead>
                    <tr>
                        <th class="lbl-sub">Subject</th>
                        <th class="lbl-max">Max</th>
                        <th class="lbl-obt">Obtained</th>
                        <th class="lbl-stat">Status</th>
                    </tr>
                </thead>
                <tbody id="c-tbody"></tbody>
            </table>

            <div class="summary-grid">
                <div class="sum-item">
                    <div class="sum-label lbl-tot">Total</div>
                    <div class="sum-val" id="c-total"></div>
                </div>
                <div class="sum-item">
                    <div class="sum-label lbl-perc">Percent</div>
                    <div class="sum-val" id="c-perc"></div>
                </div>
                <div class="sum-item">
                    <div class="sum-label lbl-grd">Grade</div>
                    <div class="sum-val" id="c-grade"></div>
                </div>
                <div class="sum-item">
                    <div class="sum-label lbl-res">Result</div>
                    <div class="sum-val" id="c-result"></div>
                </div>
            </div>

            <div class="cert-footer">
                <div class="qr-box">
                    <div id="qrcode"></div>
                    <small style="font-size: 7pt; color: #888;">Scan to Verify</small>
                </div>
                <div class="sign-box">
                    <img id="c-sign" class="sign-img hidden" src="">
                    <div class="sign-line lbl-sign">Principal Signature</div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        /**
         * ----------------------------------------------------
         * ULTRA ADMIN RESULT SYSTEM (Static Memory-Only)
         * ----------------------------------------------------
         */

        const I18N = {
            en: { name: "Name", roll: "Register No", sub: "Subject", max: "Max", obt: "Obtained", stat: "Status", tot: "Total", perc: "Percentage", grd: "Grade", res: "Result", sign: "Principal Signature" },
            mal: { name: "പേര്", roll: "രജിസ്റ്റർ നമ്പർ", sub: "വിഷയം", max: "പരമാവധി", obt: "ലഭിച്ചത്", stat: "നില", tot: "ആകെ", perc: "ശതമാനം", grd: "ഗ്രേഡ്", res: "ഫലം", sign: "പ്രിൻസിപ്പൽ" },
            ar: { name: "الاسم", roll: "رقم التسجيل", sub: "المادة", max: "الحد الأقصى", obt: "المحصلة", stat: "الحالة", tot: "المجموع", perc: "النسبة", grd: "الدرجة", res: "النتيجة", sign: "توقيع المدير" },
            ta: { name: "பெயர்", roll: "பதிவு எண்", sub: "பாடம்", max: "அதிகபட்சம்", obt: "பெற்றது", stat: "நிலை", tot: "மொத்தம்", perc: "சதவீதம்", grd: "தரம்", res: "முடிவு", sign: "முதல்வர் கையொப்பம்" },
            kn: { name: "ಹೆಸರು", roll: "ನೋಂದಣಿ ಸಂಖ್ಯೆ", sub: "ವಿಷಯ", max: "ಗರಿಷ್ಠ", obt: "ಗಳಿಸಿದ", stat: "ಸ್ಥಿತಿ", tot: "ಒಟ್ಟು", perc: "ಶೇಕಡಾವಾರು", grd: "ಶ್ರೇಣಿ", res: "ಫಲಿತಾಂಶ", sign: "ಪ್ರಾಂಶುಪಾಲರ ಸಹಿ" },
            te: { name: "పేరు", roll: "రిజిస్టర్ నంబర్", sub: "విషయం", max: "గరిష్ట", obt: "పొందిన", stat: "స్థితి", tot: "మొత్తం", perc: "శాతం", grd: "గ్రేడ్", res: "ఫలితం", sign: "ప్రిన్సిపాల్ సంతకం" },
            ur: { name: "نام", roll: "رجسٹریشن نمبر", sub: "مضمون", max: "زیادہ سے زیادہ", obt: "حاصل کردہ", stat: "حیثیت", tot: "کل", perc: "فیصد", grd: "گریڈ", res: "نتیجہ", sign: "پرنسپل کے دستخط" },
            hi: { name: "नाम", roll: "पंजीकरण संख्या", sub: "विषय", max: "अधिकतम", obt: "प्राप्त", stat: "स्थिति", tot: "कुल", perc: "प्रतिशत", grd: "श्रेणी", res: "परिणाम", sign: "प्रधानाचार्य" }
        };

        const proExamApp = {
            state: {
                rawJson: null,
                students: [], // Flattened list of active students
                schools: [], // If multi-school
                meta: { school: "Global Excellence Academy", title: "Official Statement of Marks", session: "2025-2026", lang: 'en', passVal: 35 },
                signature: null
            },

            // --- AUTH ---
            toggleAdminLogin() {
                document.getElementById('admin-login-form').classList.toggle('hidden');
            },

            adminLogin() {
                const pass = document.getElementById('adminPassInput').value;
                if (pass === "admin123") {
                    document.getElementById('public-view').classList.add('hidden');
                    document.getElementById('admin-layout').classList.remove('hidden');
                } else {
                    alert("Incorrect Password!");
                }
            },

            logout() {
                if (confirm("Logout? All unsaved memory data will be lost on refresh!")) {
                    document.getElementById('admin-layout').classList.add('hidden');
                    document.getElementById('public-view').classList.remove('hidden');
                    document.getElementById('adminPassInput').value = "";
                    document.getElementById('admin-login-form').classList.add('hidden');
                }
            },

            switchSchool(value) {
                console.log("Switching school to " + value);
                // Placeholder for future logic
            },

            // --- NAV ---
            nav(panelId, el) {
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById('panel-' + panelId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            },

            // --- DATA ---
            handleJsonUpload(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Parsing Logic: Handles both direct array or new object structure

                        let allStudents = [];
                        // Case 1: Root exams array (Previous schema)
                        if (data.exams) {
                            data.exams.forEach(ex => allStudents.push(...ex.results));
                        }
                        // Case 2: Direct array
                        else if (Array.isArray(data)) {
                            allStudents = data;
                        }
                        // Case 3: PublishedResultsStore format (Single object wrapper)
                        else if (data.data) {
                            // Recursive check? Assume data.data is array or has exams
                            if (data.data.exams) data.data.exams.forEach(ex => allStudents.push(...ex.results));
                        }

                        this.state.students = allStudents;
                        document.getElementById('upload-status').innerHTML = `✅ Loaded ${allStudents.length} Records`;
                        document.getElementById('upload-status').style.color = "green";

                        this.updateDashboard();
                        this.renderPreview();

                    } catch (err) {
                        console.error(err);
                        alert("JSON Parse Error. Check console.");
                    }
                };
                reader.readAsText(file);
            },

            // --- UI UPDATES ---
            updateDashboard() {
                const total = this.state.students.length;
                document.getElementById('d-total').textContent = total;

                // Simple analytics
                let passed = 0;
                let maxScore = 0;
                let totalScoreSum = 0;

                this.state.students.forEach(s => {
                    // Quick check based on 'total' field if exists, else 0
                    const score = s.total || 0;
                    if (score > maxScore) maxScore = score;
                    totalScoreSum += score;

                    // Assume pass if no subjects are below threshold? 
                    // For dashboard quick stats, we might blindly trust a status flag OR calc it
                    // Let's use the calc logic quickly:
                    // Assuming pass mark 35 for now
                    let isPass = true;
                    Object.values(s.subjects || {}).forEach(v => {
                        if (Number(v) < 35) isPass = false;
                    });
                    if (isPass) passed++;
                });

                const passPerc = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
                document.getElementById('d-pass').textContent = passPerc + "%";
                document.getElementById('a-topt').textContent = maxScore;
                document.getElementById('a-avg').textContent = total > 0 ? (totalScoreSum / total).toFixed(0) : 0;
            },

            renderPreview() {
                const tbody = document.getElementById('preview-table');
                tbody.innerHTML = this.state.students.slice(0, 10).map(s => `
            <tr>
                <td style="padding:10px; border-bottom:1px solid #eee;">${s.roll || s.registerNumber || '-'}</td>
                <td style="padding:10px; border-bottom:1px solid #eee;">${s.name}</td>
                <td style="padding:10px; border-bottom:1px solid #eee;">${s.total || 0}</td>
                <td style="padding:10px; border-bottom:1px solid #eee;"><button class="btn btn-sm btn-secondary" onclick="proExamApp.previewCert('${s.roll || s.registerNumber}')">View</button></td>
            </tr>
        `).join('');
            },

            // --- META & CONFIG ---
            saveMeta() {
                this.state.meta.school = document.getElementById('confSchool').value;
                this.state.meta.title = document.getElementById('confTitle').value;
                this.state.meta.session = document.getElementById('confSession').value;
                this.state.meta.lang = document.getElementById('confLang').value;
                this.state.meta.passVal = Number(document.getElementById('confPass').value);
            },

            handleSignature(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        const scale = Math.min(300 / img.width, 1);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
                        const b64 = canvas.toDataURL("image/jpeg", 0.7);
                        this.state.signature = b64;
                        document.getElementById('sig-preview').src = b64;
                    };
                };
                reader.readAsDataURL(file);
            },

            // --- SEARCH & CERTIFICATE ---
            publicSearch() {
                const reg = document.getElementById('publicRegInput').value.trim();
                if (!reg) return;
                this.previewCert(reg);
            },

            previewCert(regNo) {
                const s = this.state.students.find(st => (st.roll == regNo) || (st.registerNumber == regNo));
                if (!s) {
                    if (document.getElementById('public-msg'))
                        document.getElementById('public-msg').textContent = "Result Not Found";
                    else alert("Not Found");
                    return;
                }

                // Render Cert
                const dict = I18N[this.state.meta.lang];

                // Labels
                document.querySelector('.lbl-name').textContent = dict.name;
                document.querySelector('.lbl-roll').textContent = dict.roll;
                document.querySelector('.lbl-sub').textContent = dict.sub;
                document.querySelector('.lbl-max').textContent = dict.max;
                document.querySelector('.lbl-obt').textContent = dict.obt;
                document.querySelector('.lbl-stat').textContent = dict.stat;
                document.querySelector('.lbl-tot').textContent = dict.tot;
                document.querySelector('.lbl-perc').textContent = dict.perc;
                document.querySelector('.lbl-grd').textContent = dict.grd;
                document.querySelector('.lbl-res').textContent = dict.res;
                document.querySelector('.lbl-sign').textContent = dict.sign;

                // Data
                document.getElementById('c-school').textContent = this.state.meta.school;
                document.getElementById('c-title').textContent = this.state.meta.title;
                document.getElementById('c-session').textContent = this.state.meta.session;
                document.getElementById('c-name').textContent = s.name;
                document.getElementById('c-roll').textContent = s.roll || s.registerNumber || "-";

                // Photo
                document.getElementById('c-photo').src = s.photo || `https://ui-avatars.com/api/?name=${s.name}&background=random`;

                // Signature
                const sigEl = document.getElementById('c-sign');
                if (this.state.signature) {
                    sigEl.src = this.state.signature;
                    sigEl.classList.remove('hidden');
                } else {
                    sigEl.classList.add('hidden');
                }

                // Table
                const tbody = document.getElementById('c-tbody');
                tbody.innerHTML = "";
                let totMax = 0, totObt = 0, allPass = true;

                const subMap = s.subjects || {};
                const pVal = this.state.meta.passVal;

                for (const [sub, marks] of Object.entries(subMap)) {
                    if (sub.startsWith('@') || sub.startsWith('Column')) continue;

                    const max = 100; // Default max?
                    const m = Number(marks);

                    // Skip if 0 and key looks like filler? 
                    if (m === 0 && sub.includes("Column")) continue;

                    totMax += max;
                    totObt += m;

                    const isPass = m >= pVal;
                    if (!isPass) allPass = false;

                    tbody.innerHTML += `
                <tr>
                    <td>${sub}</td>
                    <td>${max}</td>
                    <td>${m}</td>
                    <td class="${isPass ? 'status-pass' : 'status-fail'}">${isPass ? 'PASS' : 'FAIL'}</td>
                </tr>
            `;
                }

                document.getElementById('c-total').textContent = `${totObt} / ${totMax}`;
                const perc = totMax > 0 ? (totObt / totMax * 100).toFixed(2) : 0;
                document.getElementById('c-perc').textContent = perc + "%";

                let grade = "F";
                if (allPass) {
                    if (perc >= 90) grade = "A+";
                    else if (perc >= 80) grade = "A";
                    else if (perc >= 70) grade = "B+";
                    else if (perc >= 60) grade = "B";
                    else if (perc >= 50) grade = "C+";
                    else if (perc >= 40) grade = "C";
                    else grade = "D";
                }
                document.getElementById('c-grade').textContent = allPass ? grade : "N/A";

                const resEl = document.getElementById('c-result');
                resEl.textContent = allPass ? "PASSED" : "FAILED";
                resEl.style.color = allPass ? "var(--success)" : "var(--danger)";

                // QR
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById('qrcode'), {
                    text: `${s.name}|${s.roll}|${allPass ? 'PASS' : 'FAIL'}|${perc}%`,
                    width: 80, height: 80
                });

                document.getElementById('certificate-area').classList.add('visible');
            },

            closeCert() {
                document.getElementById('certificate-area').classList.remove('visible');
            },

            downloadPDF() {
                const element = document.getElementById('printable-cert');
                html2pdf().set({
                    margin: 0,
                    filename: `Result.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).from(element).save();
            },

            async init() {
                console.log("Portal Initializing...");
                await this.fetchPublishedData();
                this.updateDashboard();
                this.renderPreview();
            },

            let publicData = null;

            async function autoLoadPublishedResults() {
                try {
                    const response = await fetch("published-results.json");
        if (!response.ok) throw new Error("No file found");

        publicData = await response.json();
        initializePortal(publicData);

    } catch (err) {
            console.log("No static file found.");
        }
}

        window.addEventListener("DOMContentLoaded", autoLoadPublishedResults);

        document.getElementById("published-results-upload")
            .addEventListener("change", function () {

                const file = this.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        publicData = JSON.parse(e.target.result);
                        initializePortal(publicData);

                        document.getElementById("published-results-status")
                            .innerHTML = "Results loaded successfully";

                    } catch (err) {
                        document.getElementById("published-results-status")
                            .innerHTML = "Invalid JSON file";
                    }
                };

                reader.readAsText(file);
            });

        function initializePortal(data) {

            const select = document.getElementById("examSelect");
            select.innerHTML = `<option value="">-- Select Exam --</option>`;

            data.exams.forEach(exam => {
                select.innerHTML += `
            <option value="${exam.examId}">
                ${exam.examName}
            </option>
        `;
            });

            select.disabled = false;

            select.addEventListener("change", function () {
                document.getElementById("submitBtn").disabled =
                    !this.value;

                document.getElementById("submitBtn").style.opacity =
                    this.value ? "1" : "0.5";
            });
        }

        document.getElementById("resultsForm")
            .addEventListener("submit", function (e) {

                e.preventDefault();

                const examId =
                    document.getElementById("examSelect").value;

                if (!examId || !publicData) {
                    alert("Please select exam.");
                    return;
                }

                const exam =
                    publicData.exams.find(e => e.examId === examId);

                const roll =
                    document.getElementById("rollInput").value.trim();

                const student =
                    exam.students.find(s =>
                        String(s.rollNo).trim() === roll
                    );

                if (!student) {
                    alert(`Result not found for Roll No: ${roll}`);
                    return;
                }

                alert("Result Found: " + student.name);
            });








            async fetchPublishedData() {
            try {
                const response = await fetch('../../data/published-results.json');
                if (!response.ok) throw new Error("No data found");
                const json = await response.json();

                if (json.meta) this.state.meta = json.meta;
                if (json.signature) this.state.signature = json.signature;

                if (json.data && json.data.exams) {
                    let allStudents = [];
                    json.data.exams.forEach(ex => allStudents.push(...ex.results));
                    this.state.students = allStudents;
                    console.log(`Loaded ${allStudents.length} published records.`);
                }
            } catch (err) {
                console.log("Static Data Fetch Skip:", err.message);
            }
        }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            proExamApp.init();
        });
    </script>
    <script src="../../assets/js/exam-app.js"></script>

</body>

</html>