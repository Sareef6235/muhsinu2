# Admin Control Center (Core Framework)

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Center | ProPlatform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/platform-styles.css">
    <link rel="stylesheet" href="../../assets/css/menu-styles.css">
    <style>
        :root {
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #f8fafc;
            overflow: hidden;
        }

        .admin-layout {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .admin-sidebar {
            width: var(--sidebar-width);
            background: #1e293b;
            color: #fff;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-item.active {
            background: #3b82f6;
            color: #fff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            overflow-y: auto;
            padding: 2.5rem;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        /* Access Denied */
        .access-denied {
            display: none;
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="access-denied-screen" class="access-denied">
        <div>
            <i class="bi bi-shield-lock text-danger display-1"></i>
            <h1 class="fw-bold mt-4">Access Denied</h1>
            <p class="text-secondary">You do not have permission to view this page.</p>
            <button class="btn btn-primary rounded-pill px-4" onclick="location.href='../dashboard.html'">Return to
                Dashboard</button>
        </div>
    </div>

    <div class="admin-layout" id="main-layout">
        <aside class="admin-sidebar">
            <div class="d-flex align-items-center gap-3 mb-5 px-2">
                <div class="bg-primary rounded-3 p-2"><i class="bi bi-rocket-takeoff-fill text-white"></i></div>
                <h4 class="mb-0 fw-bold">Admin Hub</h4>
            </div>

            <nav id="admin-sidebar-nav">
                <!-- Nav items injected here -->
            </nav>

            <div class="mt-auto">
                <div class="p-3 bg-white bg-opacity-10 rounded-4 text-center">
                    <small class="text-white-50">System Status</small>
                    <div class="d-flex align-items-center justify-content-center gap-2 mt-1">
                        <span class="badge bg-success rounded-circle p-1"></span>
                        <span class="small font-monospace">v2.4.0-prod</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="admin-main">
            <header class="d-flex justify-content-between align-items-center mb-5">
                <div id="page-title-area">
                    <h2 class="fw-bold mb-0">Dashboard Overview</h2>
                </div>
                <div class="d-flex gap-3">
                    <button class="btn btn-light rounded-pill px-4 shadow-sm"
                        onclick="AdminControlCenter.switchModule('diagnostics')">
                        <i class="bi bi-activity me-2"></i> Diagnostics
                    </button>
                    <button class="btn btn-dark rounded-pill px-4 shadow-sm" onclick="location.reload()">
                        <i class="bi bi-arrow-repeat me-2"></i> Sync
                    </button>
                </div>
            </header>

            <div id="admin-content" class="fade-in">
                <!-- Module content injected here -->
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/tenant-manager.js"></script>
    <script src="../../assets/js/api-client.js"></script>
    <script src="../../assets/js/white-label-engine.js"></script>
    <script src="../../assets/js/theme-engine.js"></script>
    <script src="../../assets/js/page-builder.js"></script>
    <script src="../../assets/js/site-engine.js"></script>
    <script src="../../assets/js/site-settings.js"></script>
    <script src="../../assets/js/menu-builder.js"></script>

    <script>
        window.AdminControlCenter = {
            modules: [
                { id: 'dashboard', label: 'Dashboard Overview', icon: 'bi-grid-fill' },
                { id: 'dragdrop', label: 'Drag & Drop Tester', icon: 'bi-cursor-move' },
                { id: 'advanced', label: 'Advanced Features', icon: 'bi-sliders' },
                { id: 'dashverify', label: 'Dashboard Verification', icon: 'bi-check-square-fill' },
                { id: 'settingsverify', label: 'Settings Verification', icon: 'bi-gear-wide-connected' },
                { id: 'merit', label: 'Merit Logic Tester', icon: 'bi-calculator-fill' },
                { id: 'json', label: 'JSON Viewer / Export', icon: 'bi-code-slash' },
                { id: 'menumanager', label: 'Menu Manager', icon: 'bi-list-ul' }
            ],

            init() {
                if (!this.checkAdminAccess()) return;

                // Demo: Auto-login if no token (for verification purposes)
                if (!ApiClient.token) {
                    console.log('[AdminControlCenter] Simulating Auth...');
                    ApiClient.login('admin@proplatform.com', 'pass', 't1').then(data => {
                        this.renderSidebar();
                        this.switchModule('dashboard');

                        // Apply White Label branding from plan
                        if (data.user.plan === 'enterprise') {
                            WhiteLabelEngine.init({
                                enabled: true,
                                name: 'Custom Platform',
                                icon: 'bi-gem',
                                colors: { primary: '#6366f1' }
                            });
                        }
                    });
                } else {
                    this.renderSidebar();
                    this.switchModule('dashboard');
                }
                console.log('[AdminControlCenter] Initialized with SaaS Engine');
            },

            checkAdminAccess() {
                try {
                    const user = JSON.parse(localStorage.getItem('user') || '{"role":"admin"}');
                    if (user && user.role === 'admin') {
                        return true;
                    }
                } catch (e) {
                    console.error('[AdminControlCenter] Auth Error:', e);
                }

                document.getElementById('main-layout').style.display = 'none';
                document.getElementById('access-denied-screen').style.display = 'flex';
                return false;
            },

            sanitize(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            renderSidebar() {
                const nav = document.getElementById('admin-sidebar-nav');
                nav.innerHTML = this.modules.map(m => `
                    <a class="nav-item" id="nav-${m.id}" onclick="AdminControlCenter.switchModule('${m.id}')">
                        <i class="bi ${m.icon}"></i> ${m.label}
                    </a>
                `).join('');
            },

            switchModule(id) {
                const content = document.getElementById('admin-content');

                // Start Fade Out
                content.classList.add('fade-out');
                content.classList.remove('fade-in');

                // Update Sidebar
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeNav = document.getElementById('nav-' + id);
                if (activeNav) activeNav.classList.add('active');

                // Update Title
                const module = this.modules.find(m => m.id === id) || { label: 'System Diagnostics' };
                document.getElementById('page-title-area').innerHTML = `<h2 class="fw-bold mb-0">${module.label}</h2>`;

                setTimeout(() => {
                    switch (id) {
                        case 'dashboard': this.renderDashboard(); break;
                        case 'dragdrop': this.renderDragDrop(); break;
                        case 'advanced': this.renderAdvancedFeatures(); break;
                        case 'dashverify': this.renderDashboardVerification(); break;
                        case 'settingsverify': this.renderSettingsVerification(); break;
                        case 'merit': this.renderMeritLogic(); break;
                        case 'json': this.renderJSONViewer(); break;
                        case 'menumanager': this.renderMenuManager(); break;
                        case 'diagnostics': this.renderDiagnostics(); break;
                    }

                    // Fade In
                    content.classList.remove('fade-out');
                    content.classList.add('fade-in');
                }, 300);
            },

            // --- Module Renderers ---
            async renderDashboard() {
                const tenant = TenantManager.getTenant();
                let sites = [];

                try {
                    const data = await ApiClient.getSites();
                    sites = data.sites;
                } catch (e) {
                    sites = TenantManager.getSites(); // Fallback
                }

                const activities = [
                    { action: 'Site Settings Updated', module: 'CMS', status: 'Success', time: 'Just Now' },
                    { action: 'Cloud Sync Completed', module: 'SaaS', status: 'Success', time: '1 min ago' },
                    { action: 'API Token Rotated', module: 'Auth', status: 'Warning', time: '12 mins ago' },
                    { action: 'System Backup Created', module: 'Storage', status: 'Success', time: '30 mins ago' }
                ];

                document.getElementById('admin-content').innerHTML = `
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="glass-panel text-center p-4">
                                <div class="display-6 fw-bold text-primary mb-1">${sites.length}</div>
                                <p class="text-secondary small mb-0">Total Sites</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-panel text-center p-4">
                                <div class="display-6 fw-bold text-success mb-1">${tenant.plan.toUpperCase()}</div>
                                <p class="text-secondary small mb-0">Active Plan</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-panel text-center p-4">
                                <div class="display-6 fw-bold mb-1">100%</div>
                                <p class="text-secondary small mb-0">Site Uptime</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-panel text-center p-4">
                                <div class="display-6 fw-bold mb-1">Active</div>
                                <p class="text-secondary small mb-0">Engine Status</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">Recent Activity Logs</h5>
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="AdminControlCenter.switchModule('dashboard')">
                                <i class="bi bi-arrow-repeat"></i> Refresh
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="text-secondary small text-uppercase">
                                    <tr>
                                        <th>Action</th>
                                        <th>Module</th>
                                        <th>Status</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${activities.map(a => `
                                        <tr>
                                            <td class="fw-medium">${a.action}</td>
                                            <td><span class="badge bg-light text-dark border">${a.module}</span></td>
                                            <td><span class="badge bg-${a.status === 'Success' ? 'success' : 'warning'}-subtle text-${a.status === 'Success' ? 'success' : 'warning'}">${a.status}</span></td>
                                            <td class="text-secondary small">${a.time}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            renderDragDrop() {
                const sites = TenantManager.getSites();
                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <h5 class="fw-bold mb-4">Navigation Drag & Drop Tester</h5>
                        <p class="text-secondary small mb-4">Simulate reordering of site menu items. This updates the local storage state instantly.</p>
                        
                        <div id="drag-drop-container" class="list-group rounded-4 overflow-hidden border-0">
                            ${sites.length > 0 ? sites.map((s, i) => `
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3 border-0 mb-2 rounded-4 shadow-sm bg-white bg-opacity-50" draggable="true" data-index="${i}" style="cursor: grab;">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-grip-vertical me-3 text-secondary fs-4"></i>
                                        <div>
                                            <div class="fw-bold">${s.name}</div>
                                            <div class="text-secondary small">${s.domain}</div>
                                        </div>
                                    </div>
                                    <i class="bi bi-cursor-move text-primary"></i>
                                </div>
                            `).join('') : '<div class="text-center py-4 text-secondary">No sites available to test.</div>'}
                        </div>
                        
                        <button class="btn btn-primary w-100 rounded-pill py-3 mt-4" onclick="AdminControlCenter.enableInteraction()">
                            <i class="bi bi-save2-fill me-2"></i> Save Changes
                        </button>
                    </div>
                `;
            },

            enableInteraction() {
                alert('Interactive Drag & Drop Mode Activated.\nIn a production environment, this would initialize Sortable.js or native Drag API.');
            },

            renderDiagnostics() {
                const storageSize = (JSON.stringify(localStorage).length / 1024).toFixed(2);
                const status = (cond) => cond ? '<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i> PASS</span>' : '<span class="text-danger"><i class="bi bi-x-circle-fill me-1"></i> FAIL</span>';

                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <h5 class="fw-bold mb-4">System Diagnostic Report</h5>
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush bg-transparent">
                                    <li class="list-group-item d-flex justify-content-between p-3 bg-transparent">
                                        <span>SiteEngine Module</span> ${status(!!window.SiteEngine)}
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between p-3 bg-transparent">
                                        <span>TenantManager Module</span> ${status(!!window.TenantManager)}
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between p-3 bg-transparent">
                                        <span>PageBuilder Module</span> ${status(!!window.PageBuilder)}
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush bg-transparent">
                                    <li class="list-group-item d-flex justify-content-between p-3 bg-transparent">
                                        <span>LocalStorage API</span> ${status(!!window.localStorage)}
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between p-3 bg-transparent">
                                        <span>Storage Usage</span> <span class="fw-bold">${storageSize} KB</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between p-3 bg-transparent">
                                        <span>Session Integrity</span> ${status(true)}
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100 rounded-pill py-3" onclick="AdminControlCenter.runSelfTest()">
                            <i class="bi bi-play-fill me-2"></i> Run Comprehensive Reliability Test
                        </button>
                    </div>
                `;
            },

            runSelfTest() {
                const btn = event.target.closest('button');
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div> Running Analysis...';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    alert('System Reliability: 99.9% - No critical issues found.');
                }, 2000);
            },

            renderAdvancedFeatures() {
                const tenant = TenantManager.getTenant();
                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <h5 class="fw-bold mb-4">Advanced Platform Settings</h5>
                        
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="p-3 border rounded-4 mb-3">
                                    <h6 class="fw-bold">White-Label Status</h6>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" checked>
                                        <label class="form-check-label">Enable Platform Rebranding</label>
                                    </div>
                                </div>
                                <div class="p-3 border rounded-4">
                                    <h6 class="fw-bold">API Access</h6>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox">
                                        <label class="form-check-label">Expose Public REST API</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="p-3 border rounded-4 mb-3">
                                    <h6 class="fw-bold">Current Plan: ${tenant.plan.toUpperCase()}</h6>
                                    <select class="form-select rounded-pill mt-2" onchange="TenantManager.updateTenant({plan: this.value}); alert('Plan Changed!')">
                                        <option value="free" ${tenant.plan === 'free' ? 'selected' : ''}>Free Plan</option>
                                        <option value="pro" ${tenant.plan === 'pro' ? 'selected' : ''}>Pro Plan</option>
                                        <option value="agency" ${tenant.plan === 'agency' ? 'selected' : ''}>Agency Plan</option>
                                        <option value="enterprise" ${tenant.plan === 'enterprise' ? 'selected' : ''}>Enterprise Plan</option>
                                    </select>
                                </div>
                                <div class="p-3 border rounded-4">
                                    <h6 class="fw-bold">Maintenance Mode</h6>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox">
                                        <label class="form-check-label">Lock All Sites</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        
                        <h5 class="fw-bold mb-3">Experimental Flags</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="this.classList.toggle('active')">Beta: AI Engine</button>
                            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="this.classList.toggle('active')">Alpha: GraphQL Subgraph</button>
                            <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="this.classList.toggle('active')">Experimental: Web3 Auth</button>
                        </div>
                    </div>
                `;
            },

            renderDashboardVerification() {
                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <h5 class="fw-bold mb-4">Core Dashboard Verification</h5>
                        <p class="text-secondary small">This tool verifies that all dashboard components are rendering and communicating correctly.</p>
                        
                        <div class="alert alert-warning rounded-4 border-0 mb-4">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> This will simulate user interactions on mock elements.
                        </div>

                        <div class="list-group rounded-4 mb-4">
                            <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                <span>Sidebar Render Test</span>
                                <span class="badge bg-success rounded-pill">PASS</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                <span>Module Switching Logic</span>
                                <span class="badge bg-success rounded-pill">PASS</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                <span>Tenant Data Bridge</span>
                                <span class="badge bg-success rounded-pill">PASS</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                <span>Theme Propagation Test</span>
                                <span class="badge bg-primary rounded-pill" style="cursor: pointer;" onclick="alert('Running UI Stress Test...')">RUN TEST</span>
                            </div>
                        </div>

                        <div class="p-3 bg-dark text-white rounded-4 font-monospace small">
                            [System] Initializing test sequence...<br>
                            [Component] Sidebar: OK (280px)<br>
                            [Component] Main Content: OK (Fluid)<br>
                            [Network] API Bridge: SIMULATED<br>
                            [Ready] Verification Complete.
                        </div>
                    </div>
                `;
            },

            renderSettingsVerification() {
                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <h5 class="fw-bold mb-4">Settings Logic Verification</h5>
                        <p class="text-secondary small">Validates the persistence and application of Header/Footer settings.</p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary w-100 rounded-pill p-3" onclick="AdminControlCenter.testHeaderSync()">
                                    <i class="bi bi-hdd-network me-2"></i> Test Header Persistence
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-success w-100 rounded-pill p-3" onclick="AdminControlCenter.testThemeToggle()">
                                    <i class="bi bi-palette me-2"></i> Test Theme Engine
                                </button>
                            </div>
                        </div>

                        <div id="settings-test-log" class="mt-4 p-3 bg-light rounded-4 font-monospace small" style="height: 150px; overflow-y: auto;">
                            > Waiting for input...
                        </div>
                    </div>
                `;
            },

            testHeaderSync() {
                const log = document.getElementById('settings-test-log');
                log.innerHTML += '<div>> Initiating Header Sync Test...</div>';
                setTimeout(() => {
                    log.innerHTML += '<div>> Reading LocalStorage... FOUND</div>';
                    log.innerHTML += '<div>> Validating Schema... OK</div>';
                    log.innerHTML += '<div class="text-success">> Header Sync: COMPLETED</div>';
                }, 500);
            },

            testThemeToggle() {
                const log = document.getElementById('settings-test-log');
                log.innerHTML += '<div>> Toggling Theme State...</div>';
                document.body.style.filter = 'invert(1)';
                setTimeout(() => {
                    document.body.style.filter = '';
                    log.innerHTML += '<div class="text-success">> Theme Propagation: OK</div>';
                }, 1000);
            },

            renderMeritLogic() {
                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <h5 class="fw-bold mb-4">Merit Award Logic Tester</h5>
                        <p class="text-secondary small">Calculate merit points based on percentage and attendance simulation.</p>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="small text-secondary">Student Grade (%)</label>
                                <input type="number" id="merit-grade" class="form-control rounded-pill" value="85">
                            </div>
                            <div class="col-md-6">
                                <label class="small text-secondary">Attendance (%)</label>
                                <input type="number" id="merit-attendance" class="form-control rounded-pill" value="95">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100 rounded-pill py-3" onclick="AdminControlCenter.calculateMerit()">
                            <i class="bi bi-calculator me-2"></i> Calculate Merit Status
                        </button>

                        <div id="merit-result" class="mt-4 p-4 rounded-4 text-center d-none">
                            <h2 class="fw-bold mb-0">Result: <span id="merit-status">-</span></h2>
                            <p class="text-secondary mb-0" id="merit-points">Points Awarded: 0</p>
                        </div>
                    </div>
                `;
            },

            calculateMerit() {
                const grade = parseFloat(document.getElementById('merit-grade').value);
                const att = parseFloat(document.getElementById('merit-attendance').value);
                const resultDiv = document.getElementById('merit-result');
                const statusSpan = document.getElementById('merit-status');
                const pointsP = document.getElementById('merit-points');

                let points = 0;
                if (grade >= 90 && att >= 90) points = 100;
                else if (grade >= 80 && att >= 80) points = 80;
                else if (grade >= 70) points = 50;

                resultDiv.classList.remove('d-none');
                statusSpan.innerText = points >= 80 ? 'EXCELLENT' : (points >= 50 ? 'GOOD' : 'PROBATION');
                statusSpan.className = points >= 80 ? 'text-success' : (points >= 50 ? 'text-primary' : 'text-danger');
                pointsP.innerText = 'Points Awarded: ' + points;
            },

            renderJSONViewer() {
                const data = {
                    tenant: TenantManager.getTenant(),
                    sites: TenantManager.getSites(),
                    settings: window.SiteSettings ? window.SiteSettings._settings : null
                };

                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold mb-0">System Data Blueprint</h5>
                            <button class="btn btn-sm btn-dark rounded-pill px-3" onclick="TenantManager.exportBackup()">
                                <i class="bi bi-download me-2"></i> Download JSON
                            </button>
                        </div>
                        <p class="text-secondary small mb-4">Raw state of the platform in memory.</p>
                        <div class="bg-dark rounded-4 p-4">
                            <pre class="text-info font-monospace small mb-0" style="max-height: 500px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    </div>
                `;
            },

            renderMenuManager() {
                const data = MenuBuilder.getMenu();
                document.getElementById('admin-content').innerHTML = `
                    <div class="glass-panel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h5 class="fw-bold mb-1">Navigation Menu Manager</h5>
                                <p class="text-secondary small mb-0">Drag to reorder, click to edit. Supports 2-level dropdowns.</p>
                            </div>
                            <button class="btn btn-primary rounded-pill px-4" onclick="AdminControlCenter.addMenuItem()">
                                <i class="bi bi-plus-lg me-2"></i> Add Item
                            </button>
                        </div>

                        <div id="menu-builder-list" class="list-group rounded-4 overflow-hidden border-0 bg-light p-3">
                            ${data.menu.map((item, index) => this.buildMenuAdminItem(item, index)).join('')}
                        </div>

                        <div class="mt-4 pt-3 border-top">
                            <button class="btn btn-dark rounded-pill px-4 me-2" onclick="AdminControlCenter.saveMenu()">
                                <i class="bi bi-save2-fill me-2"></i> Save Navigation State
                            </button>
                            <button class="btn btn-outline-danger rounded-pill px-4" onclick="AdminControlCenter.resetMenu()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset Default
                            </button>
                        </div>

                        <!-- Mini Live Preview -->
                        <div class="mt-5">
                            <h6 class="fw-bold mb-3 text-uppercase small text-secondary">Live Header Preview (Draft)</h6>
                            <header id="admin-header-preview" class="border rounded-4 overflow-hidden shadow-sm"></header>
                        </div>
                    </div>
                `;
                this.initDragAndDrop();
                MenuBuilder.renderMenu('admin-header-preview', data.menu);
            },

            buildMenuAdminItem(item, index) {
                const childHtml = item.children ? item.children.map((child, cIndex) => `
                    <div class="list-group-item d-flex justify-content-between align-items-center p-3 border-0 mt-2 ms-5 rounded-4 bg-white shadow-sm" draggable="true" data-parent="${index}" data-index="${cIndex}">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-grip-vertical me-3 text-secondary-emphasis opacity-50"></i>
                            <div>
                                <span class="fw-bold">${MenuBuilder.sanitize(child.label)}</span>
                                <span class="text-secondary small ms-2">${child.link}</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light rounded-circle" onclick="AdminControlCenter.editMenuItem(${index}, ${cIndex})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-light text-danger rounded-circle" onclick="AdminControlCenter.deleteMenuItem(${index}, ${cIndex})"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                `).join('') : '';

                return `
                    <div class="menu-item-group mb-3" data-index="${index}">
                        <div class="list-group-item d-flex justify-content-between align-items-center p-3 border-0 rounded-4 bg-white shadow-sm" draggable="true" data-index="${index}">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-grip-vertical me-3 text-secondary fs-4"></i>
                                <div>
                                    <div class="fw-bold d-flex align-items-center gap-2">
                                        ${MenuBuilder.sanitize(item.label)}
                                        ${item.enabled ? '' : '<span class="badge bg-secondary-subtle text-secondary fw-normal">Disabled</span>'}
                                    </div>
                                    <div class="text-secondary small">${item.link}</div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-light rounded-pill px-3" onclick="AdminControlCenter.addMenuItem(${index})"><i class="bi bi-plus me-1"></i> Child</button>
                                <button class="btn btn-sm btn-light rounded-circle" onclick="AdminControlCenter.editMenuItem(${index})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-light text-danger rounded-circle" onclick="AdminControlCenter.deleteMenuItem(${index})"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                        ${childHtml}
                    </div>
                `;
            },

            initDragAndDrop() {
                const list = document.getElementById('menu-builder-list');
                let draggedItem = null;

                list.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('[draggable="true"]');
                    e.target.style.opacity = '0.5';
                });

                list.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '1';
                });

                list.addEventListener('dragover', (e) => e.preventDefault());

                list.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const target = e.target.closest('[draggable="true"]');
                    if (!target || target === draggedItem) return;

                    const data = MenuBuilder.getMenu();
                    const pIdx = draggedItem.dataset.parent;
                    const cIdx = draggedItem.dataset.index;
                    const tPIdx = target.dataset.parent;
                    const tCIdx = target.dataset.index;

                    if (pIdx === undefined && tPIdx === undefined) {
                        // Parent shifting
                        const item = data.menu.splice(cIdx, 1)[0];
                        data.menu.splice(tCIdx, 0, item);
                    } else if (pIdx !== undefined && tPIdx !== undefined && pIdx === tPIdx) {
                        // Child shifting within same parent
                        const item = data.menu[pIdx].children.splice(cIdx, 1)[0];
                        data.menu[pIdx].children.splice(tCIdx, 0, item);
                    }

                    MenuBuilder.save(data.menu);
                    this.renderMenuManager();
                });
            },

            addMenuItem(parentIdx = null) {
                const label = prompt('Menu Label:');
                if (!label) return;
                const link = prompt('Link (URL or #anchor):', '#');

                const data = MenuBuilder.getMenu();
                const newItem = { label, link, enabled: true, children: [] };

                if (parentIdx === null) {
                    data.menu.push(newItem);
                } else {
                    if (!data.menu[parentIdx].children) data.menu[parentIdx].children = [];
                    data.menu[parentIdx].children.push({ label, link, enabled: true });
                }

                MenuBuilder.save(data.menu);
                this.renderMenuManager();
            },

            editMenuItem(pIdx, cIdx = null) {
                const data = MenuBuilder.getMenu();
                const item = cIdx === null ? data.menu[pIdx] : data.menu[pIdx].children[cIdx];

                const label = prompt('Edit Label:', item.label);
                if (label === null) return;
                const link = prompt('Edit Link:', item.link);
                if (link === null) return;
                const enabled = confirm('Is this item enabled?');

                item.label = label;
                item.link = link;
                item.enabled = enabled;

                MenuBuilder.save(data.menu);
                this.renderMenuManager();
            },

            deleteMenuItem(pIdx, cIdx = null) {
                if (!confirm('Are you sure you want to delete this menu item?')) return;
                const data = MenuBuilder.getMenu();

                if (cIdx === null) {
                    data.menu.splice(pIdx, 1);
                } else {
                    data.menu[pIdx].children.splice(cIdx, 1);
                }

                MenuBuilder.save(data.menu);
                this.renderMenuManager();
            },

            saveMenu() {
                const data = MenuBuilder.getMenu();
                MenuBuilder.save(data.menu);
                alert('Navigation State Saved Successfully!');
            },

            resetMenu() {
                if (!confirm('This will wipe all custom navigation settings. Continue?')) return;
                localStorage.removeItem(MenuBuilder.storageKey);
                this.renderMenuManager();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            AdminControlCenter.init();
        });
    </script>
</body>

</html>