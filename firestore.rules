rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üõ°Ô∏è SECURITY HELPERS
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() &&
             exists(userPath) &&
             get(userPath).data.role == 'admin';
    }

    // üë§ USERS COLLECTION
    match /users/{userId} {
      // Users can always read their own document
      allow read: if isSignedIn() && request.auth.uid == userId;

      // Self-registration for new students
      allow create: if isSignedIn() &&
                    request.auth.uid == userId &&
                    request.resource.data.role == 'student' &&
                    request.resource.data.approved == false;

      // Restricted updates: Users can only change specific profile fields
      // Use .diff() to ensure role and approved status aren't modified
      allow update: if isSignedIn() &&
                    request.auth.uid == userId &&
                    request.resource.data.diff(resource.data).affectedKeys()
                    .hasOnly(['name', 'class', 'roll', 'updatedAt']);

      // Admin Bypass: Admins can do everything
      allow read, write: if isAdmin();
    }

    // üìÖ BOOKINGS COLLECTION
    match /bookings/{bookingId} {
      // Basic schema validation for public booking creation
      allow create: if request.resource.data.email is string &&
                    request.resource.data.name is string &&
                    request.resource.data.subjectId is string;
      
      allow read, write: if isAdmin();
    }

    // üìö SUBJECTS COLLECTION
    match /subjects/{subjectId} {
      allow read: if true; // Public read access for the booking form
      allow write: if isAdmin();
    }

    // üñºÔ∏è IMAGES COLLECTION
    match /images/{imageId} {
      allow read: if true; // Publicly viewable
      allow write: if isSignedIn() &&
                    (request.auth.uid == request.resource.data.userId || isAdmin());
    }

    // ‚ùå REMOVED: connection_test for security
  }
}
