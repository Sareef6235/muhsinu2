rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // üõ°Ô∏è SECURITY HELPERS
    
    // Check if the user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Robust admin check (prevents rule crashes on missing docs)
    function isAdmin() {
      // 1. Must be signed in
      // 2. Document MUST exist (prevents get() from throwing an error)
      // 3. User role field must match 'admin'
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() &&
             exists(userPath) &&
             get(userPath).data.role == 'admin';
    }

    // üë§ USERS COLLECTION
    match /users/{userId} {
      
      /**
       * 1. SELF-READ
       * Every user can read their own document.
       */
      allow read: if isSignedIn() && request.auth.uid == userId;

      /**
       * 2. SELF-CREATE (Registration)
       * Standard: Students must be approved = false.
       * Exception: Bootstrap emails can register as approved admins.
       */
      allow create: if isSignedIn() && request.auth.uid == userId && (
        (request.resource.data.role == 'student' && request.resource.data.approved == false) ||
        (request.auth.token.email in ['123v213@gmail.com', '123v214@gmail.com'] && 
         request.resource.data.role == 'admin' && request.resource.data.approved == true)
      );

      /**
       * 3. SELF-UPDATE (Profile & Dev Bootstrap)
       * Standard: Can update name/class/roll but NOT role/approval.
       * Exception: Bootstrap emails can self-upgrade to admin if stuck as student.
       */
      allow update: if isSignedIn() && request.auth.uid == userId && (
        (request.resource.data.role == resource.data.role && 
         request.resource.data.approved == resource.data.approved &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'class', 'roll', 'updatedAt'])) ||
        (request.auth.token.email in ['123v213@gmail.com', '123v214@gmail.com'] && 
         request.resource.data.role == 'admin' && request.resource.data.approved == true)
      );

      /**
       * 4. ADMIN BYPASS
       */
      allow read, write: if isAdmin();
    }

    // üìÖ BOOKINGS
    match /bookings/{bookingId} {
      allow create: if true; // Public booking
      allow read, write: if isAdmin();
    }

    // üìö SUBJECTS
    match /subjects/{subjectId} {
      allow read: if true; // Public list
      allow write: if isAdmin();
    }

    // üñºÔ∏è IMAGES
    match /images/{imageId} {
      allow read: if true;
      allow write: if isSignedIn() && 
                    (request.auth.uid == request.resource.data.userId || isAdmin());
    }
  }
}
